import{H as Z,u as q,r as c,j as e,S as U,R as J,L as Q,B as O,U as K}from"./index-C4yNIdvx.js";import{F as ee}from"./index-l2mFcCMN.js";import{u as se}from"./useAdmin-BOl-G2gZ.js";import"./iconBase-6Dj9gBMc.js";const M="https://4v4gg-chat-relay.fly.dev",D=20,G=[{value:"",label:"All tags"},{value:"highlight",label:"Highlight"},{value:"fail",label:"Fail"},{value:"flame",label:"Flame"}];function ae(s){const t=Math.round(s),a=Math.floor(t/60),n=t%60;return a>0?`${a}:${String(n).padStart(2,"0")}`:`0:${String(n).padStart(2,"0")}`}function le(s){const t=Date.now()-new Date(s).getTime(),a=Math.floor(t/36e5);if(a<1)return"just now";if(a<24)return`${a}h ago`;const n=Math.floor(a/24);if(n===1)return"1 day ago";if(n<30)return`${n} days ago`;const r=Math.floor(n/30);return r===1?"1 month ago":`${r} months ago`}function te(s){return s?s.replace(/-/g," ").replace(/\b\w/g,t=>t.toUpperCase()):null}function P(s){return s?s.split(",").map(t=>t.trim()).filter(Boolean):[]}function ne({value:s,onAdd:t,onRemove:a}){const n=P(s),[r,j]=c.useState(""),[d,u]=c.useState([]),[p,f]=c.useState(!1),[o,y]=c.useState(!1),g=c.useRef(null);c.useEffect(()=>{if(r.length<2){u([]),f(!1);return}y(!0);const i=setTimeout(async()=>{var L,$,w,A,R,v,m,S;const h=await K(r),b=new Set(n),N=[];for(const x of Array.isArray(h)?h:[]){const k=(($=(L=x.playersInfo)==null?void 0:L[0])==null?void 0:$.battleTag)||((R=(A=(w=x.player)==null?void 0:w.playerIds)==null?void 0:A[0])==null?void 0:R.battleTag);!k||b.has(k)||(b.add(k),N.push({battleTag:k,mmr:(v=x.player)==null?void 0:v.mmr,wins:((m=x.player)==null?void 0:m.wins)||0,losses:((S=x.player)==null?void 0:S.losses)||0}))}u(N.slice(0,6)),f(!0),y(!1)},300);return()=>clearTimeout(i)},[r]),c.useEffect(()=>{if(!p)return;const i=h=>{g.current&&!g.current.contains(h.target)&&f(!1)};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[p]);const T=i=>{j(""),f(!1),u([]),t(i)};return e.jsxs("div",{className:"clip-player-search",ref:g,children:[n.length>0&&e.jsx("div",{className:"clip-player-chips",children:n.map(i=>e.jsxs("span",{className:"clip-player-chip",children:[i.split("#")[0],e.jsx("button",{className:"clip-player-chip-x",onClick:()=>a(i),children:"×"})]},i))}),e.jsx("input",{className:"clip-player-search-input",type:"text",value:r,onChange:i=>j(i.target.value),onFocus:()=>d.length>0&&f(!0),placeholder:n.length?"Add player...":"Tag player..."}),p&&d.length>0&&e.jsx("div",{className:"clip-player-search-dropdown",children:d.map(i=>{const[h,b]=i.battleTag.split("#");return e.jsxs("button",{className:"clip-player-search-result",onClick:()=>T(i.battleTag),children:[e.jsxs("span",{className:"clip-player-search-info",children:[e.jsxs("span",{className:"clip-player-search-name-row",children:[e.jsx("span",{className:"clip-player-search-name",children:h}),e.jsxs("span",{className:"clip-player-search-hash",children:["#",b]})]}),e.jsxs("span",{className:"clip-player-search-meta",children:[e.jsxs("span",{className:"clip-player-search-w",children:[i.wins,"W"]}),e.jsxs("span",{className:"clip-player-search-l",children:[i.losses,"L"]})]})]}),e.jsx("span",{className:"clip-player-search-mmr",children:i.mmr!=null?`${Math.round(i.mmr)} MMR`:"—"})]},i.battleTag)})}),o&&r.length>=2&&!p&&e.jsx("div",{className:"clip-player-search-dropdown",children:e.jsxs("div",{className:"clip-player-search-loading",children:["Zug zug",e.jsx("span",{className:"ellipsis-anim"})]})})]})}async function _(s,t,a){return(await fetch(`${M}/api/clips/admin/${s}`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":a},body:JSON.stringify(t)})).ok}function z({clip:s}){const t=P(s.player_tag);return e.jsxs("div",{className:"clip-meta",children:[e.jsx("span",{className:"clip-streamer",children:s.twitch_login}),t.length>0&&t.map(a=>e.jsxs(J.Fragment,{children:[e.jsx("span",{className:"clip-meta-sep",children:"·"}),e.jsx(Q,{className:"clip-player-link",to:`/player/${encodeURIComponent(a)}`,onClick:n=>n.stopPropagation(),children:a.split("#")[0]})]},a)),e.jsx("span",{className:"clip-meta-sep",children:"·"}),e.jsxs("span",{className:"clip-views",children:[s.view_count.toLocaleString()," views"]}),e.jsx("span",{className:"clip-meta-sep",children:"·"}),e.jsx("span",{className:"clip-date",children:le(s.created_at)}),s.tag&&e.jsx("span",{className:"clip-tag",children:te(s.tag)})]})}function W({clip:s,apiKey:t,onUpdate:a}){const n=!!s.featured,[r,j]=c.useState(s.tag||""),d=async o=>{j(o),await _("feature",{clipId:s.clip_id,tag:o||null},t),a()},u=async o=>{const y=P(s.player_tag);if(y.includes(o))return;const g=[...y,o].join(",");await _("tag-player",{clipId:s.clip_id,playerTag:g},t),a()},p=async o=>{const g=P(s.player_tag).filter(T=>T!==o).join(",")||null;await _("tag-player",{clipId:s.clip_id,playerTag:g},t),a()},f=async()=>{await _("unhide",{clipId:s.clip_id},t)&&a()};return s.hidden?e.jsx("div",{className:"clip-admin-actions",children:e.jsx(O,{$secondary:!0,onClick:f,children:"Restore"})}):e.jsxs("div",{className:"clip-admin-actions",children:[e.jsx("span",{className:"clip-admin-label",children:"4v4?"}),e.jsx(O,{$ghost:!0,className:n?"clip-admin-vote--active":"",onClick:async()=>{n||await _("feature",{clipId:s.clip_id,tag:null},t)&&a()},children:"Yes"}),e.jsx(O,{$ghost:!0,className:`clip-admin-vote--no ${n?"":"clip-admin-vote--active"}`,onClick:async()=>{await _("hide",{clipId:s.clip_id},t)&&a()},children:"No"}),n&&e.jsxs(U,{value:r,onChange:o=>d(o.target.value),children:[e.jsx("option",{value:"",children:"No tag"}),G.slice(1).map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))]}),e.jsx(ne,{value:s.player_tag,onAdd:u,onRemove:p})]})}function B({clip:s,onClick:t,apiKey:a,onUpdate:n}){return e.jsxs("div",{className:`clip-card ${s.featured?"clip-card--featured":""}`,onClick:()=>t(s),children:[e.jsxs("div",{className:"clip-thumbnail-wrap",children:[e.jsx("img",{className:"clip-thumbnail",src:s.thumbnail_url,alt:s.title,loading:"lazy",onError:r=>{r.target.style.display="none"}}),e.jsx("div",{className:"clip-play-overlay",children:e.jsx("div",{className:"clip-play-btn",children:e.jsx("div",{className:"clip-play-icon"})})}),s.duration>0&&e.jsx("span",{className:"clip-duration",children:ae(s.duration)})]}),e.jsxs("div",{className:"clip-info",children:[e.jsx("h3",{className:"clip-title",children:s.title}),e.jsx(z,{clip:s})]}),a&&e.jsx("div",{onClick:r=>r.stopPropagation(),children:e.jsx(W,{clip:s,apiKey:a,onUpdate:n})})]})}function ie({clip:s,onClose:t,apiKey:a,onUpdate:n}){const r=c.useRef(null),j=s.embed_url?`${s.embed_url}&parent=4v4.gg&parent=localhost&autoplay=true`:`https://clips.twitch.tv/embed?clip=${s.clip_id}&parent=4v4.gg&parent=localhost&autoplay=true`;return c.useEffect(()=>{var u;(u=r.current)==null||u.focus();const d=p=>{p.key==="Escape"&&t()};return window.addEventListener("keydown",d,!0),()=>window.removeEventListener("keydown",d,!0)},[t]),e.jsx("div",{className:"clip-modal-backdrop",ref:r,tabIndex:-1,onClick:t,onKeyDown:d=>d.key==="Escape"&&t(),children:e.jsxs("div",{className:"clip-modal",onClick:d=>d.stopPropagation(),children:[e.jsx("button",{className:"clip-modal-close",onClick:t,children:"×"}),e.jsx("iframe",{className:"clip-modal-embed",src:j,allowFullScreen:!0,title:s.title}),e.jsxs("div",{className:"clip-modal-info",children:[e.jsx("h2",{className:"clip-modal-title",children:s.title}),e.jsx(z,{clip:s}),a&&e.jsx(W,{clip:s,apiKey:a,onUpdate:n})]})]})})}function he(){const s=Z(),t=q(),a=c.useMemo(()=>new URLSearchParams(s.search).get("player")||"",[s.search]),[n,r]=c.useState([]),[j,d]=c.useState([]),[u,p]=c.useState(!0),[f,o]=c.useState(!1),[y,g]=c.useState(!0),[T,i]=c.useState(0),[h,b]=c.useState(""),[N,L]=c.useState(""),[$,w]=c.useState(null),[A,R]=c.useState(!1),{adminKey:v,isAdmin:m}=se(),S=c.useCallback(async(l,V=!1)=>{try{const C=new URLSearchParams({limit:String(D),offset:String(l)});h&&C.set("streamer",h),N&&C.set("tag",N),a&&C.set("player",a);const X=m?`${M}/api/clips/admin/all?${C}`:`${M}/api/clips?${C}`,F=await fetch(X,{headers:m?{"X-API-Key":v}:{}});if(!F.ok)throw new Error(`${F.status}`);const H=await F.json();r(V?Y=>[...Y,...H.clips]:H.clips),g(H.clips.length===D)}catch(C){console.error("[Clips] Fetch error:",C.message),V||r([]),g(!1)}},[h,N,a,m,v]);c.useEffect(()=>{p(!0),i(0),S(0).finally(()=>p(!1))},[S]),c.useEffect(()=>{fetch(`${M}/api/clips/streamers`).then(l=>l.ok?l.json():{streamers:[]}).then(l=>d(l.streamers||[])).catch(()=>{})},[]);const x=()=>{i(0),S(0)},k=async()=>{const l=T+D;o(!0),i(l),await S(l,!0),o(!1)},I=m?n.filter(l=>!l.hidden):n,E=m?n.filter(l=>l.hidden):[];return e.jsxs("div",{className:"clips",children:[e.jsxs("div",{className:"clips-container",children:[e.jsxs("div",{className:"clips-header",children:[e.jsxs("h1",{className:"clips-title",children:[e.jsx(ee,{className:"clips-twitch-icon"}),"Clips"]}),e.jsx("p",{className:"clips-subtitle",children:"Top moments from WC3 streamers"})]}),e.jsxs("div",{className:"clips-filters",children:[a&&e.jsxs("div",{className:"clips-player-filter",children:[e.jsx("span",{className:"clips-player-tag",children:a.split("#")[0]}),e.jsx("button",{className:"clips-player-clear",onClick:()=>t.push("/clips"),title:"Clear player filter",children:"×"})]}),e.jsxs(U,{value:h,onChange:l=>b(l.target.value),children:[e.jsx("option",{value:"",children:"All streamers"}),j.map(l=>e.jsx("option",{value:l.twitch_login,children:l.display_name},l.twitch_login))]}),e.jsx(U,{value:N,onChange:l=>L(l.target.value),children:G.map(l=>e.jsx("option",{value:l.value,children:l.label},l.value))})]}),u?e.jsx("div",{className:"clips-loading",children:"Loading clips..."}):I.length===0&&E.length===0?e.jsx("div",{className:"clips-empty",children:"No clips found"}):e.jsxs(e.Fragment,{children:[I.length>0&&e.jsx("div",{className:"clips-grid",children:I.map(l=>e.jsx(B,{clip:l,onClick:w,apiKey:m?v:null,onUpdate:x},l.clip_id))}),y&&e.jsx("div",{className:"clips-load-more",children:e.jsx("button",{className:"clips-load-more-btn",onClick:k,disabled:f,children:f?"Loading...":"Load more"})}),m&&E.length>0&&e.jsxs("div",{className:"clips-hidden-drawer",children:[e.jsxs("button",{className:"clips-hidden-toggle",onClick:()=>R(l=>!l),children:[A?"Hide":"Show"," irrelevant (",E.length,")"]}),A&&e.jsx("div",{className:"clips-grid clips-grid--hidden",children:E.map(l=>e.jsx(B,{clip:l,onClick:w,apiKey:v,onUpdate:x},l.clip_id))})]})]})]}),$&&e.jsx(ie,{clip:$,onClose:()=>w(null),apiKey:m?v:null,onUpdate:()=>{w(null),x()}})]})}export{he as default};

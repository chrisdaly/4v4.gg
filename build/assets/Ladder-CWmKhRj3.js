import{R as Se,j as e,G as je,r as be,L as ke,F as Ce,a as n,b as ue,g as Re,c as ve,d as Te,e as Le,f as xe,h as $e,i as De,k as Pe,l as Ee,m as Ie}from"./index-CAUlyqcI.js";import{b as ye}from"./index-7SyHiHbq.js";const Fe=({rank:i,sparklineData:C,session:o,detectedRace:Y,twitch:q,isStreaming:Z,streamInfo:v,isLive:w,isEven:ee})=>{var X,x,L,y,N,O,$,m;const{name:R,mmr:E,wins:I,losses:H,winrate:T,race:se}=i.player||{},F=((x=(X=i.playersInfo)==null?void 0:X[0])==null?void 0:x.battleTag)||((N=(y=(L=i.player)==null?void 0:L.playerIds)==null?void 0:y[0])==null?void 0:N.battleTag)||"",M=Y??se??(($=(O=i.playersInfo)==null?void 0:O[0])==null?void 0:$.calculatedRace),W=be[M],J=i.rankNumber,G=T?Math.round(T*1e4)/100:0,S=F.replace("#","%23");return e.jsxs("div",{className:`ladder-row ${w?"is-live":""} ${ee?"even":"odd"}`,children:[e.jsxs("div",{className:"col-rank",children:[w&&e.jsx(je,{className:"in-game-icon"}),e.jsx("span",{className:"rank-number",children:J})]}),e.jsxs("div",{className:"col-player",children:[e.jsx("img",{src:W,alt:"",className:"player-race-icon"}),e.jsx(ke,{to:`/player/${S}`,className:"player-name-link",children:R}),q&&Z&&e.jsx("a",{href:`https://twitch.tv/${q}`,target:"_blank",rel:"noopener noreferrer",className:"twitch-link",title:`${(v==null?void 0:v.title)||"Streaming"} (${(v==null?void 0:v.viewerCount)||0} viewers)`,children:e.jsx(Ce,{className:"twitch-icon"})})]}),e.jsx("div",{className:"col-mmr",children:e.jsx("span",{className:"mmr-value",children:E})}),e.jsxs("div",{className:"col-record",children:[e.jsx("span",{className:"wins",children:I}),e.jsx("span",{className:"record-separator",children:"-"}),e.jsx("span",{className:"losses",children:H})]}),e.jsx("div",{className:"col-winrate",children:e.jsxs("span",{className:G>=50?"winrate-positive":"winrate-negative",children:[G.toFixed(1),"%"]})}),e.jsx("div",{className:"col-session",children:o?e.jsxs("div",{className:"session-inline-row",children:[e.jsxs("span",{className:"session-record",children:[e.jsx("span",{className:"wins",children:o.wins}),e.jsx("span",{className:"record-separator",children:"-"}),e.jsx("span",{className:"losses",children:o.losses})]}),e.jsxs("span",{className:`session-mmr ${o.mmrChange>=0?"positive":"negative"}`,children:[o.mmrChange>=0?"+":"",o.mmrChange]}),((m=o.form)==null?void 0:m.length)>0&&e.jsx("div",{className:"form-dots-inline",children:o.form.map((ae,z)=>e.jsx("span",{className:`form-dot ${ae?"win":"loss"}`},z))})]}):e.jsx("span",{className:"session-none",children:"-"})}),e.jsx("div",{className:"col-form",children:C.length>0?e.jsx(ye.Sparklines,{data:C.slice(-50),width:120,height:24,children:e.jsx(ye.SparklinesLine,{style:{strokeWidth:1.5,stroke:"var(--gold)",fill:"none"}})}):e.jsx("div",{className:"sparkline-placeholder"})})]})},Me=Se.memo(Fe),Oe=()=>{const[i,C]=n.useState(null),[o,Y]=n.useState(0),[q,Z]=n.useState([]),[v,w]=n.useState([]),[ee,R]=n.useState(!0),[E,I]=n.useState({}),[H,T]=n.useState({}),[se,F]=n.useState({}),[M,W]=n.useState({}),[J,G]=n.useState(new Map),[S,X]=n.useState(new Set),[x,L]=n.useState(""),[y,N]=n.useState(null),[O,$]=n.useState(!1),[m,ae]=n.useState("rank"),[z,ce]=n.useState("asc");n.useEffect(()=>{(async()=>{try{const l=await Re();if(l&&l.length>0){Z(l);const a=l[0].id;C(a);const t=ve(0,a);t&&(w(t),R(!1))}}catch(l){console.error("Failed to fetch seasons:",l),C(24)}})()},[]),n.useEffect(()=>{const s=async()=>{try{const a=await Te(),t=new Set;a!=null&&a.matches&&a.matches.forEach(r=>{var d;(d=r.teams)==null||d.forEach(h=>{var u;(u=h.players)==null||u.forEach(g=>{g.battleTag&&t.add(g.battleTag.toLowerCase())})})}),X(t)}catch(a){console.error("Failed to fetch ongoing games:",a)}};s();const l=setInterval(s,3e4);return()=>clearInterval(l)},[]),n.useEffect(()=>{const s=Object.values(M).filter(Boolean);if(s.length===0){G(new Map);return}const l=async()=>{const t=await Le(s);G(t)};l();const a=setInterval(l,6e4);return()=>clearInterval(a)},[M]),n.useEffect(()=>{if(i===null)return;const s=`ladderPlayerData:${o}:${i}`;(async()=>{const a=ve(o,i),t=xe.get(s);a&&a.length>0?(w(a),R(!1),t&&(I(t.sparklines||{}),T(t.sessions||{}),F(t.races||{}),W(t.twitch||{}))):(R(!0),I({}),T({}),F({}),W({}));try{const r=await $e(o,i);w(r),Ne(r,i,s)}catch(r){console.error("Failed to fetch ladder:",r),w([])}finally{R(!1)}})()},[i,o]);const Ne=async(s,l,a)=>{const r={},d={},h={},u={};for(let g=0;g<s.length;g+=5){const k=s.slice(g,g+5).map(async c=>{var V,K,_;const f=(V=c.playersInfo[0])==null?void 0:V.battleTag,A=((K=c.player)==null?void 0:K.race)??((_=c.playersInfo[0])==null?void 0:_.calculatedRace);if(!f)return null;let B=[];try{B=await Pe(f,l)}catch{}let Q=null;try{const p=await Ee(f,A);Q=(p==null?void 0:p.session)||null}catch{}let U=null;try{const p=await Ie(f);U=(p==null?void 0:p.twitch)||null}catch{}return{battleTag:f,sparkline:B,session:Q,detectedRace:A,twitch:U}});(await Promise.all(k)).forEach(c=>{c&&(r[c.battleTag]=c.sparkline,d[c.battleTag]=c.session,c.detectedRace!==void 0&&c.detectedRace!==null&&(h[c.battleTag]=c.detectedRace),c.twitch&&(u[c.battleTag]=c.twitch))}),I(c=>({...c,...r})),T(c=>({...c,...d})),F(c=>({...c,...h})),W(c=>({...c,...u}))}xe.set(a,{sparklines:r,sessions:d,races:h,twitch:u},300*1e3)},fe=s=>{C(parseInt(s.target.value,10))},we=s=>{Y(parseInt(s.target.value,10)),L(""),N(null)};n.useEffect(()=>{if(!x||x.length<2){N(null),$(!1);return}const l=setTimeout(async()=>{$(!0);try{const t=await(await fetch(`https://website-backend.w3champions.com/api/ladder/search?gateWay=${De}&searchFor=${encodeURIComponent(x)}&gameMode=4&season=${i}`)).json();N(t||[])}catch(a){console.error("Search failed:",a),N([])}finally{$(!1)}},300);return()=>clearTimeout(l)},[x,i]);const b=s=>{m===s?ce(z==="asc"?"desc":"asc"):(ae(s),ce(s==="rank"||s==="race"?"asc":"desc"))},ne=y!==null?y:v,re=s=>{var r,d;const l=(d=(r=s.playersInfo)==null?void 0:r[0])==null?void 0:d.battleTag,a=H[l];if((a==null?void 0:a.mmrChange)!==void 0)return a.mmrChange;const t=E[l];if((t==null?void 0:t.length)>=2){const h=t.slice(-10);return h[h.length-1]-h[0]}return 0},ie=s=>{var a,t;const l=(t=(a=s.playersInfo)==null?void 0:a[0])==null?void 0:t.battleTag;return l&&S.has(l.toLowerCase())?1:0},oe=n.useMemo(()=>[...ne].sort((s,l)=>{var r,d,h,u,g,D,k,P,c,f,A,B,Q,U,V,K,_,p,he,me;let a,t;switch(m){case"rank":a=s.rankNumber,t=l.rankNumber;break;case"mmr":a=((r=s.player)==null?void 0:r.mmr)||0,t=((d=l.player)==null?void 0:d.mmr)||0;break;case"wins":a=((h=s.player)==null?void 0:h.wins)||0,t=((u=l.player)==null?void 0:u.wins)||0;break;case"losses":a=((g=s.player)==null?void 0:g.losses)||0,t=((D=l.player)==null?void 0:D.losses)||0;break;case"winrate":{const te=((k=s.player)==null?void 0:k.wins)||0,ge=((P=s.player)==null?void 0:P.losses)||0,le=((c=l.player)==null?void 0:c.wins)||0,pe=((f=l.player)==null?void 0:f.losses)||0;a=te+ge>0?te/(te+ge):0,t=le+pe>0?le/(le+pe):0;break}case"games":a=(((A=s.player)==null?void 0:A.wins)||0)+(((B=s.player)==null?void 0:B.losses)||0),t=(((Q=l.player)==null?void 0:Q.wins)||0)+(((U=l.player)==null?void 0:U.losses)||0);break;case"race":a=((V=s.player)==null?void 0:V.race)??((_=(K=s.playersInfo)==null?void 0:K[0])==null?void 0:_.calculatedRace)??99,t=((p=l.player)==null?void 0:p.race)??((me=(he=l.playersInfo)==null?void 0:he[0])==null?void 0:me.calculatedRace)??99;break;case"momentum":a=re(s),t=re(l);break;case"live":a=ie(s),t=ie(l);break;default:return 0}return z==="asc"?a-t:t-a}),[ne,m,z,E,S]),de=n.useMemo(()=>v.filter(s=>{var a,t;const l=(t=(a=s.playersInfo)==null?void 0:a[0])==null?void 0:t.battleTag;return l&&S.has(l.toLowerCase())}).length,[v,S]),j=ue.find(s=>s.id===o);return e.jsxs("div",{className:"ladder-page",children:[e.jsxs("div",{className:"ladder-header",children:[e.jsx("div",{className:"ladder-title-section",children:y!==null?e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"ladder-title",children:"Search Results"}),e.jsx("div",{className:"ladder-stats",children:e.jsxs("span",{className:"stat-item",children:[y.length," players found"]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"ladder-league-title",children:[e.jsx("img",{src:j==null?void 0:j.icon,alt:"",className:"league-icon-title"}),e.jsx("h1",{className:"ladder-title",children:j==null?void 0:j.name})]}),e.jsxs("div",{className:"ladder-stats",children:[e.jsxs("span",{className:"stat-item",children:[v.length," players"]}),de>0&&e.jsxs("span",{className:"stat-item in-game",children:[e.jsx(je,{className:"in-game-icon-small"}),de," in game"]})]})]})}),e.jsxs("div",{className:"ladder-controls",children:[e.jsxs("div",{className:"ladder-search",children:[e.jsx("input",{type:"text",placeholder:"Search all leagues...",value:x,onChange:s=>L(s.target.value)}),x&&e.jsx("button",{className:"search-clear",onClick:()=>{L(""),N(null)},children:"Ã—"})]}),e.jsxs("div",{className:"ladder-selectors",children:[e.jsxs("div",{className:"league-selector",children:[e.jsx("img",{src:j==null?void 0:j.icon,alt:"",className:"league-icon"}),e.jsx("select",{id:"league-select",value:o,onChange:we,disabled:y!==null,children:ue.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsx("div",{className:"season-selector",children:e.jsx("select",{id:"season-select",value:i||"",onChange:fe,children:q.map(s=>e.jsxs("option",{value:s.id,children:["S",s.id]},s.id))})})]})]})]}),e.jsx("div",{className:"ladder-container",children:ee||O?e.jsxs("div",{className:"ladder-loading",children:[e.jsx("div",{className:"loader-spinner lg"}),e.jsx("span",{className:"loader-text",children:O?"Searching":"Loading ladder"})]}):e.jsxs("div",{className:"ladder-table",children:[e.jsxs("div",{className:"ladder-header-row",children:[e.jsx("div",{className:`col-rank sortable ${m==="rank"?"active":""}`,onClick:()=>b("rank"),children:"Rank"}),e.jsx("div",{className:`col-player sortable ${m==="race"?"active":""}`,onClick:()=>b("race"),children:"Player"}),e.jsx("div",{className:`col-mmr sortable ${m==="mmr"?"active":""}`,onClick:()=>b("mmr"),children:"MMR"}),e.jsx("div",{className:`col-record sortable ${m==="games"?"active":""}`,onClick:()=>b("games"),children:"Record"}),e.jsx("div",{className:`col-winrate sortable ${m==="winrate"?"active":""}`,onClick:()=>b("winrate"),children:"Win%"}),e.jsx("div",{className:`col-session sortable ${m==="momentum"?"active":""}`,onClick:()=>b("momentum"),children:"Session"}),e.jsx("div",{className:`col-form sortable ${m==="live"?"active":""}`,onClick:()=>b("live"),children:"Form"})]}),oe.length===0?e.jsx("div",{className:"ladder-no-results",children:y!==null?`No players found matching "${x}"`:"No players in this league"}):oe.map((s,l)=>{var u,g,D,k,P;const a=((g=(u=s.playersInfo)==null?void 0:u[0])==null?void 0:g.battleTag)||((P=(k=(D=s.player)==null?void 0:D.playerIds)==null?void 0:k[0])==null?void 0:P.battleTag),t=a&&S.has(a.toLowerCase()),r=M[a],d=r&&J.has(r.toLowerCase()),h=d?J.get(r.toLowerCase()):null;return e.jsx(Me,{rank:s,sparklineData:E[a]||[],session:H[a]||null,detectedRace:se[a],twitch:r||null,isStreaming:d,streamInfo:h,isLive:t,isEven:l%2===0},s.id)})]})})]})};export{Oe as default};

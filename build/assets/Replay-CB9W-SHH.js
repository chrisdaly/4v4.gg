import{u as ge,r as c,j as e,W as he,O as ye}from"./index-B9PX3LSb.js";const ae="https://4v4gg-chat-relay.fly.dev",fe=[1,10,50,100],ve=[{label:"Last hour",hours:1},{label:"Last 6h",hours:6},{label:"Last 24h",hours:24},{label:"Last 3 days",hours:72}],be=m=>!m||m.length!==2?"":String.fromCodePoint(...[...m.toUpperCase()].map(f=>127462+f.charCodeAt(0)-65)),Me=m=>{if(!m)return"--:--:--";const f=m.getHours().toString().padStart(2,"0"),i=m.getMinutes().toString().padStart(2,"0"),M=m.getSeconds().toString().padStart(2,"0");return`${f}:${i}:${M}`},je=m=>m?m.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"}):"",xe=m=>{const f=m.getHours(),i=m.getMinutes();return`${f}:${i<10?"0"+i:i}`},U=m=>{const f=m.getFullYear(),i=String(m.getMonth()+1).padStart(2,"0"),M=String(m.getDate()).padStart(2,"0"),v=String(m.getHours()).padStart(2,"0"),l=String(m.getMinutes()).padStart(2,"0");return`${f}-${i}-${M}T${v}:${l}`},Te=()=>{const m=new Date;return m.setHours(m.getHours()-1),U(m)},Se=()=>U(new Date),Ne=({events:m,onEventClick:f})=>e.jsxs("div",{className:"replay-panel replay-events",children:[e.jsxs("div",{className:"replay-section-header",children:[e.jsx("span",{className:"replay-section-title",children:"Activity"}),e.jsxs("span",{className:"replay-section-count",children:[m.length," events"]})]}),e.jsxs("div",{className:"event-feed-list",children:[m.length===0&&e.jsx("div",{className:"replay-empty",children:"No events yet..."}),m.map((i,M)=>e.jsxs("div",{className:"event-item event-item-clickable",onClick:()=>f&&i.rawIdx!=null&&f(i.rawIdx),children:[e.jsx("span",{className:`event-dot event-${i.type}`}),e.jsxs("div",{className:"event-body",children:[e.jsxs("div",{className:"event-main",children:[i.country&&e.jsx("span",{className:"event-flag",children:be(i.country)}),e.jsx("span",{className:"event-name",children:i.type==="game_start"?(i.players||[]).slice(0,2).join(", ")+((i.players||[]).length>2?` +${i.players.length-2}`:""):i.type==="game_end"?"Game ended":i.player}),e.jsx("span",{className:"event-time",children:xe(i.time)})]}),e.jsxs("div",{className:"event-detail",children:[i.type==="join"&&"joined",i.type==="leave"&&"left",i.type==="game_start"&&(i.map?`started on ${i.map}`:"started a game"),i.type==="game_end"&&((i.results||[]).length>0?e.jsx("div",{className:"event-game-results",children:[...i.results].sort((v,l)=>l.delta-v.delta).map((v,l)=>e.jsxs("div",{className:"event-game-row",children:[e.jsx("span",{className:"event-game-name",children:v.name}),e.jsxs("span",{className:v.delta>0?"event-delta-gain":"event-delta-loss",children:[v.delta>0?"+":"",v.delta]})]},l))}):e.jsx("span",{children:(i.players||[]).slice(0,4).join(", ")}))]})]})]},`${i.type}-${M}`))]})]}),ke=()=>{var te;const m=ge(),[f,i]=c.useState(Te),[M,v]=c.useState(Se),[l,q]=c.useState([]),[F,Y]=c.useState(!1),[V,B]=c.useState(null),[L,se]=c.useState(null),[I,N]=c.useState(!1),[j,ne]=c.useState(10),[w,P]=c.useState(0),[A,$]=c.useState(null),k=c.useRef(!1),J=c.useRef(j),C=c.useRef(0),E=c.useRef(null),T=c.useRef(null),x=c.useRef(null),[H,R]=c.useState(new Map),[b,D]=c.useState(new Map),[re,S]=c.useState([]),le=c.useMemo(()=>{var n;let a=1/0,s=-1/0;for(const t of l)if(!(t.type!=="game_start"&&t.type!=="game_end"))for(const p of((n=t.payload)==null?void 0:n.players)||[]){const u=p.currentMmr||p.oldMmr;u!=null&&u>0&&(u<a&&(a=u),u>s&&(s=u))}return a===1/0?null:[a-50,s+50]},[l]),K=c.useMemo(()=>j<=1?1:j<=10?.3:j<=50?.1:.05,[j]);c.useEffect(()=>{fetch(`${ae}/api/chat/events/summary`).then(a=>a.json()).then(se).catch(()=>{})},[]);const O=c.useCallback(async(a,s)=>{Y(!0),B(null),N(!1),k.current=!1;try{const n=new Date(a||f).toISOString(),t=new Date(s||M).toISOString(),p=await fetch(`${ae}/api/chat/events?from=${encodeURIComponent(n)}&to=${encodeURIComponent(t)}`);if(!p.ok)throw new Error(`HTTP ${p.status}`);const u=await p.json();q(u.events||[]),z()}catch(n){B(n.message),q([])}finally{Y(!1)}},[f,M]),Q=c.useCallback(a=>{const s=new Date,n=new Date(s.getTime()-a*60*60*1e3);i(U(n)),v(U(s)),O(n.toISOString(),s.toISOString())},[O]),X=c.useRef(!1);c.useEffect(()=>{X.current||(X.current=!0,Q(1))},[]);const z=c.useCallback(()=>{P(0),C.current=0,$(null),x.current=null,R(new Map),D(new Map),S([]),T.current=null},[]);c.useEffect(()=>{J.current=j},[j]),c.useEffect(()=>{k.current=I},[I]);const Z=c.useCallback((a,s)=>{const{type:n,payload:t,timestamp:p}=a,u=new Date(p);switch(n){case"join":{R(o=>{const g=new Map(o);return g.set(t.battleTag,{battleTag:t.battleTag,name:t.name||t.battleTag.split("#")[0],clanTag:t.clanTag||""}),g}),S(o=>[{type:"join",player:t.name||t.battleTag.split("#")[0],tag:t.battleTag,country:null,time:u,rawIdx:s},...o].slice(0,100));break}case"leave":{R(o=>{const g=new Map(o);return g.delete(t.battleTag),g}),S(o=>[{type:"leave",player:t.name||t.battleTag.split("#")[0],tag:t.battleTag,country:null,time:u,rawIdx:s},...o].slice(0,100));break}case"game_start":{D(g=>{const r=new Map(g);return r.set(t.matchId,t),r});const o=(t.players||[]).map(g=>{var r;return g.name||((r=g.battleTag)==null?void 0:r.split("#")[0])});S(g=>[{type:"game_start",players:o,map:t.map,matchId:t.matchId,time:u,rawIdx:s},...g].slice(0,100));break}case"game_end":{D(r=>{const d=new Map(r);return d.delete(t.matchId),d});const o=(t.players||[]).map(r=>{var d;return r.name||((d=r.battleTag)==null?void 0:d.split("#")[0])}),g=(t.players||[]).filter(r=>r.oldMmr!=null&&r.currentMmr!=null&&r.oldMmr!==r.currentMmr).map(r=>{var d;return{name:r.name||((d=r.battleTag)==null?void 0:d.split("#")[0]),delta:Math.round(r.currentMmr-r.oldMmr),mmr:r.currentMmr}});S(r=>[{type:"game_end",players:o,results:g,matchId:t.matchId,time:u,rawIdx:s},...r].slice(0,100));break}}},[]);c.useEffect(()=>{if(!I||l.length===0)return;const a=C.current;x.current==null&&a<l.length&&(x.current=new Date(l[a].timestamp).getTime());const s=n=>{if(k.current){if(T.current!=null){const p=(n-T.current)*J.current;x.current+=p;const u=x.current;let o=C.current;for(;o<l.length&&!(new Date(l[o].timestamp).getTime()>u);)Z(l[o],o),o++;C.current=o,P(o),$(new Date(u)),o>=l.length&&(N(!1),k.current=!1)}T.current=n,k.current&&(E.current=requestAnimationFrame(s))}};return T.current=null,E.current=requestAnimationFrame(s),()=>{E.current&&cancelAnimationFrame(E.current)}},[I,l,Z]);const ce=c.useCallback(a=>{var u;const s=parseInt(a.target.value,10),n=new Map,t=new Map,p=[];for(let o=0;o<s&&o<l.length;o++){const g=l[o],{type:r,payload:d,timestamp:W}=g,y=new Date(W);switch(r){case"join":n.set(d.battleTag,{battleTag:d.battleTag,name:d.name||d.battleTag.split("#")[0],clanTag:d.clanTag||""});break;case"leave":n.delete(d.battleTag);break;case"game_start":t.set(d.matchId,d);break;case"game_end":t.delete(d.matchId);break}p.length>=50&&p.pop(),p.unshift({type:r,player:r==="join"||r==="leave"?d.name||((u=d.battleTag)==null?void 0:u.split("#")[0]):void 0,players:r==="game_start"||r==="game_end"?(d.players||[]).map(h=>{var _;return h.name||((_=h.battleTag)==null?void 0:_.split("#")[0])}):void 0,results:r==="game_end"?(d.players||[]).filter(h=>h.oldMmr!=null&&h.currentMmr!=null&&h.oldMmr!==h.currentMmr).map(h=>{var _;return{name:h.name||((_=h.battleTag)==null?void 0:_.split("#")[0]),delta:Math.round(h.currentMmr-h.oldMmr),mmr:h.currentMmr}}):void 0,map:d.map,matchId:d.matchId,time:y,rawIdx:o})}if(R(n),D(t),S(p),P(s),C.current=s,T.current=null,s<l.length){const o=new Date(l[s].timestamp);$(o),x.current=o.getTime()}else if(l.length>0){const o=new Date(l[l.length-1].timestamp);$(o),x.current=o.getTime()}},[l]),oe=c.useCallback(a=>{var p;N(!1),k.current=!1,E.current&&cancelAnimationFrame(E.current);const s=new Map,n=new Map,t=[];for(let u=0;u<a&&u<l.length;u++){const o=l[u],{type:g,payload:r,timestamp:d}=o,W=new Date(d);switch(g){case"join":s.set(r.battleTag,{battleTag:r.battleTag,name:r.name||r.battleTag.split("#")[0],clanTag:r.clanTag||""});break;case"leave":s.delete(r.battleTag);break;case"game_start":n.set(r.matchId,r);break;case"game_end":n.delete(r.matchId);break}t.length>=50&&t.pop(),t.unshift({type:g,player:g==="join"||g==="leave"?r.name||((p=r.battleTag)==null?void 0:p.split("#")[0]):void 0,players:g==="game_start"||g==="game_end"?(r.players||[]).map(y=>{var h;return y.name||((h=y.battleTag)==null?void 0:h.split("#")[0])}):void 0,results:g==="game_end"?(r.players||[]).filter(y=>y.oldMmr!=null&&y.currentMmr!=null&&y.oldMmr!==y.currentMmr).map(y=>{var h;return{name:y.name||((h=y.battleTag)==null?void 0:h.split("#")[0]),delta:Math.round(y.currentMmr-y.oldMmr),mmr:y.currentMmr}}):void 0,map:r.map,matchId:r.matchId,time:W,rawIdx:u})}if(R(s),D(n),S(t),P(a),C.current=a,T.current=null,a<l.length){const u=new Date(l[a].timestamp);$(u),x.current=u.getTime()}setTimeout(()=>N(!0),80)},[l]),ie=c.useCallback(()=>{if(w>=l.length&&l.length>0){z(),setTimeout(()=>N(!0),50);return}N(a=>!a)},[w,l.length,z]),me=c.useCallback(a=>{a&&m.push(`/player/${encodeURIComponent(a)}`)},[m]),ue=c.useMemo(()=>[...b.values()].map(a=>({id:a.matchId,mapName:a.map,teams:[{players:(a.players||[]).filter((s,n)=>n<4).map(s=>({battleTag:s.battleTag,oldMmr:s.oldMmr||s.currentMmr||0,currentMmr:s.currentMmr||s.oldMmr||0,race:s.race}))},{players:(a.players||[]).filter((s,n)=>n>=4).map(s=>({battleTag:s.battleTag,oldMmr:s.oldMmr||s.currentMmr||0,currentMmr:s.currentMmr||s.oldMmr||0,race:s.race}))}]})),[b]),G=c.useMemo(()=>{const a=new Set,s=[];for(const[n,t]of H)a.add(n),s.push({battleTag:n,name:t.name||n.split("#")[0],mmr:null,race:null,wins:0,losses:0,rank:null});for(const n of b.values())for(const t of n.players||[])if(t.battleTag&&!a.has(t.battleTag)){a.add(t.battleTag);const p=t.currentMmr||t.oldMmr||0;s.push({battleTag:t.battleTag,name:t.name||t.battleTag.split("#")[0],mmr:p>0?p:null,race:t.race??null,wins:0,losses:0,rank:null})}return s.filter(n=>n.mmr!=null)},[H,b]),ee=c.useMemo(()=>{const a=new Set;for(const n of b.values())for(const t of n.players||[])t.battleTag&&a.add(t.battleTag);const s=new Map;for(const n of b.values())for(const t of n.players||[]){if(!t.country||!t.battleTag)continue;const p=t.country.toUpperCase();s.has(p)||s.set(p,{online:0,inGame:0}),s.get(p).inGame++}return s},[b]),de=c.useMemo(()=>{const a=[];for(const s of b.values())for(const n of s.players||[]){if(!n.country||!n.battleTag)continue;const t=n.currentMmr||n.oldMmr||null;a.push({battleTag:n.battleTag,name:n.name||n.battleTag.split("#")[0],country:n.country.toUpperCase(),mmr:t,inGame:!0})}return a},[b]),pe=l.length>0?w/l.length*100:0;return e.jsxs("div",{className:"replay",children:[e.jsxs("div",{className:"replay-controls",children:[e.jsxs("div",{className:"replay-controls-row",children:[e.jsx("div",{className:"replay-presets",children:ve.map(a=>e.jsx("button",{className:"replay-btn replay-btn-preset",onClick:()=>Q(a.hours),disabled:F,children:a.label},a.hours))}),e.jsxs("div",{className:"replay-date-inputs",children:[e.jsxs("label",{children:[e.jsx("span",{className:"replay-label",children:"From"}),e.jsx("input",{type:"datetime-local",value:f,onChange:a=>i(a.target.value)})]}),e.jsxs("label",{children:[e.jsx("span",{className:"replay-label",children:"To"}),e.jsx("input",{type:"datetime-local",value:M,onChange:a=>v(a.target.value)})]}),e.jsx("button",{className:"replay-btn replay-btn-load",onClick:()=>O(),disabled:F,children:F?"Loading...":"Load"})]}),e.jsxs("div",{className:"replay-playback",children:[e.jsx("button",{className:"replay-btn replay-btn-play",onClick:ie,disabled:l.length===0,children:I?"⏸":w>=l.length&&l.length>0?"⟳":"▶"}),e.jsx("div",{className:"replay-speed-btns",children:fe.map(a=>e.jsxs("button",{className:`replay-btn replay-btn-speed ${j===a?"active":""}`,onClick:()=>ne(a),children:[a,"x"]},a))})]}),e.jsxs("div",{className:"replay-clock",children:[e.jsx("span",{className:"replay-clock-date",children:A?je(A):""}),e.jsx("span",{className:"replay-clock-time",children:Me(A)})]}),e.jsxs("div",{className:"replay-stats",children:[e.jsxs("span",{children:[H.size," chatting"]}),e.jsxs("span",{children:[b.size," games"]}),e.jsxs("span",{children:[w,"/",l.length]})]})]}),l.length>0&&e.jsxs("div",{className:"replay-scrubber",children:[e.jsx("input",{type:"range",min:0,max:l.length,value:w,onChange:ce,className:"replay-range"}),e.jsx("div",{className:"replay-progress-bar",style:{width:`${pe}%`}})]}),V&&e.jsx("div",{className:"replay-error",children:V}),L&&!l.length&&!F&&e.jsx("div",{className:"replay-summary",children:L.totalEvents>0?`${L.totalEvents.toLocaleString()} events recorded · ${((te=L.days)==null?void 0:te.length)||0} days`:"No events recorded yet. Events will appear once the server starts recording."})]}),e.jsxs("div",{className:"replay-viz",children:[e.jsxs("div",{className:"replay-panel replay-world-map",children:[e.jsxs("div",{className:"replay-section-header",children:[e.jsx("span",{className:"replay-section-title",children:"World Map"}),e.jsxs("span",{className:"replay-section-count",children:[ee.size," countries"]})]}),e.jsx(he,{playerCountries:ee,players:de,instant:!0,animationScale:K,time:A})]}),e.jsxs("div",{className:"replay-panel replay-mmr-chart",children:[e.jsxs("div",{className:"replay-section-header",children:[e.jsx("span",{className:"replay-section-title",children:"MMR Distribution"}),e.jsxs("span",{className:"replay-section-count",children:[G.length," players"]})]}),G.length>0?e.jsx(ye,{players:G,matches:ue,onPlayerClick:me,mmrRange:le,animationScale:K}):e.jsx("div",{className:"replay-empty",children:"Waiting for match data..."})]}),e.jsx(Ne,{events:re,onEventClick:oe})]})]})};export{ke as default};

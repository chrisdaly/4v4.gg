import{R as be,j as e,l as ke,L as Ce,r as n,m as ue,I as Re,S as ve,P as Le,n as Te,o as ye,g as $e,d as xe,p as Pe,k as Ie,q as De,s as Ee,t as Fe}from"./index-C4yNIdvx.js";import{b as je}from"./index-MlseYx7F.js";import{G as fe}from"./index-Dum7voYv.js";import{F as Me}from"./index-l2mFcCMN.js";import{g as We}from"./twitchService-D5TnHh44.js";import"./iconBase-6Dj9gBMc.js";const ze=({rank:i,sparklineData:C,session:o,detectedRace:Y,twitch:K,isStreaming:Z,streamInfo:v,isLive:N,isEven:ee})=>{var J,y,T,x,f,X,$,m;const{name:R,mmr:D,wins:E,losses:_,winrate:L,race:se}=i.player||{},F=((y=(J=i.playersInfo)==null?void 0:J[0])==null?void 0:y.battleTag)||((f=(x=(T=i.player)==null?void 0:T.playerIds)==null?void 0:x[0])==null?void 0:f.battleTag)||"",M=Y??se??(($=(X=i.playersInfo)==null?void 0:X[0])==null?void 0:$.calculatedRace),W=ke[M],H=i.rankNumber,z=L?Math.round(L*1e4)/100:0,S=F.replace("#","%23");return e.jsxs("div",{className:`ladder-row ${N?"is-live":""} ${ee?"even":"odd"}`,children:[e.jsxs("div",{className:"col-rank",children:[N&&e.jsx(fe,{className:"in-game-icon"}),e.jsx("span",{className:"rank-number",children:H})]}),e.jsxs("div",{className:"col-player",children:[e.jsx("img",{src:W,alt:"",className:"player-race-icon"}),e.jsx(Ce,{to:`/player/${S}`,className:"player-name-link",children:R}),K&&Z&&e.jsx("a",{href:`https://twitch.tv/${K}`,target:"_blank",rel:"noopener noreferrer",className:"twitch-link",title:`${(v==null?void 0:v.title)||"Streaming"} (${(v==null?void 0:v.viewerCount)||0} viewers)`,children:e.jsx(Me,{className:"twitch-icon"})})]}),e.jsx("div",{className:"col-mmr",children:e.jsx("span",{className:"mmr-value",children:D})}),e.jsxs("div",{className:"col-record",children:[e.jsx("span",{className:"wins",children:E}),e.jsx("span",{className:"record-separator",children:"-"}),e.jsx("span",{className:"losses",children:_})]}),e.jsx("div",{className:"col-winrate",children:e.jsxs("span",{className:z>=50?"winrate-positive":"winrate-negative",children:[z.toFixed(1),"%"]})}),e.jsx("div",{className:"col-session",children:o?e.jsxs("div",{className:"session-inline-row",children:[e.jsxs("span",{className:"session-record",children:[e.jsx("span",{className:"wins",children:o.wins}),e.jsx("span",{className:"record-separator",children:"-"}),e.jsx("span",{className:"losses",children:o.losses})]}),e.jsxs("span",{className:`session-mmr ${o.mmrChange>=0?"positive":"negative"}`,children:[o.mmrChange>=0?"+":"",o.mmrChange]}),((m=o.form)==null?void 0:m.length)>0&&e.jsx("div",{className:"form-dots-inline",children:o.form.map((ae,G)=>e.jsx("span",{className:`form-dot ${ae?"win":"loss"}`},G))})]}):e.jsx("span",{className:"session-none",children:"-"})}),e.jsx("div",{className:"col-form",children:C.length>0?e.jsx(je.Sparklines,{data:C.slice(-50),width:80,height:18,children:e.jsx(je.SparklinesLine,{style:{strokeWidth:1.5,stroke:"var(--gold)",fill:"none"}})}):e.jsx("div",{className:"sparkline-placeholder"})})]})},Ge=be.memo(ze),qe=()=>{const[i,C]=n.useState(null),[o,Y]=n.useState(0),[K,Z]=n.useState([]),[v,N]=n.useState([]),[ee,R]=n.useState(!0),[D,E]=n.useState({}),[_,L]=n.useState({}),[se,F]=n.useState({}),[M,W]=n.useState({}),[H,z]=n.useState(new Map),[S,J]=n.useState(new Set),[y,T]=n.useState(""),[x,f]=n.useState(null),[X,$]=n.useState(!1),[m,ae]=n.useState("rank"),[G,ce]=n.useState("asc");n.useEffect(()=>{(async()=>{try{const l=await Te();if(l&&l.length>0){Z(l);const a=l[0].id;C(a);const t=ye(0,a);t&&(N(t),R(!1))}}catch(l){console.error("Failed to fetch seasons:",l),C(24)}})()},[]),n.useEffect(()=>{const s=async()=>{try{const a=await $e(),t=new Set;a!=null&&a.matches&&a.matches.forEach(r=>{var d;(d=r.teams)==null||d.forEach(h=>{var u;(u=h.players)==null||u.forEach(p=>{p.battleTag&&t.add(p.battleTag.toLowerCase())})})}),J(t)}catch(a){console.error("Failed to fetch ongoing games:",a)}};s();const l=setInterval(s,3e4);return()=>clearInterval(l)},[]),n.useEffect(()=>{const s=Object.values(M).filter(Boolean);if(s.length===0){z(new Map);return}const l=async()=>{const t=await We(s);z(t)};l();const a=setInterval(l,6e4);return()=>clearInterval(a)},[M]),n.useEffect(()=>{if(i===null)return;const s=`ladderPlayerData:${o}:${i}`;(async()=>{const a=ye(o,i),t=xe.get(s);a&&a.length>0?(N(a),R(!1),t&&(E(t.sparklines||{}),L(t.sessions||{}),F(t.races||{}),W(t.twitch||{}))):(R(!0),E({}),L({}),F({}),W({}));try{const r=await Pe(o,i);N(r),we(r,i,s)}catch(r){console.error("Failed to fetch ladder:",r),N([])}finally{R(!1)}})()},[i,o]);const we=async(s,l,a)=>{const r={},d={},h={},u={};for(let p=0;p<s.length;p+=5){const k=s.slice(p,p+5).map(async c=>{var U,V,q;const w=(U=c.playersInfo[0])==null?void 0:U.battleTag,O=((V=c.player)==null?void 0:V.race)??((q=c.playersInfo[0])==null?void 0:q.calculatedRace);if(!w)return null;let A=[];try{A=await De(w,l)}catch{}let B=null;try{const g=await Ee(w,O);B=(g==null?void 0:g.session)||null}catch{}let Q=null;try{const g=await Fe(w);Q=(g==null?void 0:g.twitch)||null}catch{}return{battleTag:w,sparkline:A,session:B,detectedRace:O,twitch:Q}});(await Promise.all(k)).forEach(c=>{c&&(r[c.battleTag]=c.sparkline,d[c.battleTag]=c.session,c.detectedRace!==void 0&&c.detectedRace!==null&&(h[c.battleTag]=c.detectedRace),c.twitch&&(u[c.battleTag]=c.twitch))}),E(c=>({...c,...r})),L(c=>({...c,...d})),F(c=>({...c,...h})),W(c=>({...c,...u}))}xe.set(a,{sparklines:r,sessions:d,races:h,twitch:u},300*1e3)},Ne=s=>{C(parseInt(s.target.value,10))},Se=s=>{Y(parseInt(s.target.value,10)),T(""),f(null)};n.useEffect(()=>{if(!y||y.length<2){f(null),$(!1);return}const l=setTimeout(async()=>{$(!0);try{const t=await(await fetch(`https://website-backend.w3champions.com/api/ladder/search?gateWay=${Ie}&searchFor=${encodeURIComponent(y)}&gameMode=4&season=${i}`)).json();f(t||[])}catch(a){console.error("Search failed:",a),f([])}finally{$(!1)}},300);return()=>clearTimeout(l)},[y,i]);const b=s=>{m===s?ce(G==="asc"?"desc":"asc"):(ae(s),ce(s==="rank"||s==="race"?"asc":"desc"))},ne=x!==null?x:v,re=s=>{var r,d;const l=(d=(r=s.playersInfo)==null?void 0:r[0])==null?void 0:d.battleTag,a=_[l];if((a==null?void 0:a.mmrChange)!==void 0)return a.mmrChange;const t=D[l];if((t==null?void 0:t.length)>=2){const h=t.slice(-10);return h[h.length-1]-h[0]}return 0},ie=s=>{var a,t;const l=(t=(a=s.playersInfo)==null?void 0:a[0])==null?void 0:t.battleTag;return l&&S.has(l.toLowerCase())?1:0},oe=n.useMemo(()=>[...ne].sort((s,l)=>{var r,d,h,u,p,P,k,I,c,w,O,A,B,Q,U,V,q,g,he,me;let a,t;switch(m){case"rank":a=s.rankNumber,t=l.rankNumber;break;case"mmr":a=((r=s.player)==null?void 0:r.mmr)||0,t=((d=l.player)==null?void 0:d.mmr)||0;break;case"wins":a=((h=s.player)==null?void 0:h.wins)||0,t=((u=l.player)==null?void 0:u.wins)||0;break;case"losses":a=((p=s.player)==null?void 0:p.losses)||0,t=((P=l.player)==null?void 0:P.losses)||0;break;case"winrate":{const te=((k=s.player)==null?void 0:k.wins)||0,pe=((I=s.player)==null?void 0:I.losses)||0,le=((c=l.player)==null?void 0:c.wins)||0,ge=((w=l.player)==null?void 0:w.losses)||0;a=te+pe>0?te/(te+pe):0,t=le+ge>0?le/(le+ge):0;break}case"games":a=(((O=s.player)==null?void 0:O.wins)||0)+(((A=s.player)==null?void 0:A.losses)||0),t=(((B=l.player)==null?void 0:B.wins)||0)+(((Q=l.player)==null?void 0:Q.losses)||0);break;case"race":a=((U=s.player)==null?void 0:U.race)??((q=(V=s.playersInfo)==null?void 0:V[0])==null?void 0:q.calculatedRace)??99,t=((g=l.player)==null?void 0:g.race)??((me=(he=l.playersInfo)==null?void 0:he[0])==null?void 0:me.calculatedRace)??99;break;case"momentum":a=re(s),t=re(l);break;case"live":a=ie(s),t=ie(l);break;default:return 0}return G==="asc"?a-t:t-a}),[ne,m,G,D,S]),de=n.useMemo(()=>v.filter(s=>{var a,t;const l=(t=(a=s.playersInfo)==null?void 0:a[0])==null?void 0:t.battleTag;return l&&S.has(l.toLowerCase())}).length,[v,S]),j=ue.find(s=>s.id===o);return e.jsxs("div",{className:"ladder-page",children:[e.jsxs("div",{className:"ladder-header",children:[e.jsx("div",{className:"ladder-title-section",children:x!==null?e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"ladder-title",children:"Search Results"}),e.jsx("div",{className:"ladder-stats",children:e.jsxs("span",{className:"stat-item",children:[x.length," players found"]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"ladder-league-title",children:[e.jsx("img",{src:j==null?void 0:j.icon,alt:"",className:"league-icon-title"}),e.jsx("h1",{className:"ladder-title",children:j==null?void 0:j.name})]}),e.jsxs("div",{className:"ladder-stats",children:[e.jsxs("span",{className:"stat-item",children:[v.length," players"]}),de>0&&e.jsxs("span",{className:"stat-item in-game",children:[e.jsx(fe,{className:"in-game-icon-small"}),de," in game"]})]})]})}),e.jsxs("div",{className:"ladder-controls",children:[e.jsxs("div",{className:"ladder-search",children:[e.jsx(Re,{type:"text",placeholder:"Search all leagues...",value:y,onChange:s=>T(s.target.value)}),y&&e.jsx("button",{className:"search-clear",onClick:()=>{T(""),f(null)},children:"Ã—"})]}),e.jsxs("div",{className:"ladder-selectors",children:[e.jsxs("div",{className:"league-selector",children:[e.jsx("img",{src:j==null?void 0:j.icon,alt:"",className:"league-icon"}),e.jsx(ve,{id:"league-select",value:o,onChange:Se,disabled:x!==null,style:{paddingLeft:"34px"},children:ue.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsx("div",{className:"season-selector",children:e.jsx(ve,{id:"season-select",value:i||"",onChange:Ne,children:K.map(s=>e.jsxs("option",{value:s.id,children:["S",s.id]},s.id))})})]})]})]}),ee||X?e.jsx("div",{className:"ladder-loading",children:e.jsx(Le,{size:"md"})}):e.jsxs("div",{className:"ladder-table",children:[e.jsxs("div",{className:"ladder-header-row",children:[e.jsx("div",{className:`col-rank sortable ${m==="rank"?"active":""}`,onClick:()=>b("rank"),children:"Rank"}),e.jsx("div",{className:`col-player sortable ${m==="race"?"active":""}`,onClick:()=>b("race"),children:"Player"}),e.jsx("div",{className:`col-mmr sortable ${m==="mmr"?"active":""}`,onClick:()=>b("mmr"),children:"MMR"}),e.jsx("div",{className:`col-record sortable ${m==="games"?"active":""}`,onClick:()=>b("games"),children:"Record"}),e.jsx("div",{className:`col-winrate sortable ${m==="winrate"?"active":""}`,onClick:()=>b("winrate"),children:"Win%"}),e.jsx("div",{className:`col-session sortable ${m==="momentum"?"active":""}`,onClick:()=>b("momentum"),children:"Session"}),e.jsx("div",{className:`col-form sortable ${m==="live"?"active":""}`,onClick:()=>b("live"),children:"Form"})]}),e.jsx("div",{className:"ladder-body scrollbar-thin",children:oe.length===0?e.jsx("div",{className:"ladder-no-results",children:x!==null?`No players found matching "${y}"`:"No players in this league"}):oe.map((s,l)=>{var u,p,P,k,I;const a=((p=(u=s.playersInfo)==null?void 0:u[0])==null?void 0:p.battleTag)||((I=(k=(P=s.player)==null?void 0:P.playerIds)==null?void 0:k[0])==null?void 0:I.battleTag),t=a&&S.has(a.toLowerCase()),r=M[a],d=r&&H.has(r.toLowerCase()),h=d?H.get(r.toLowerCase()):null;return e.jsx(Ge,{rank:s,sparklineData:D[a]||[],session:_[a]||null,detectedRace:se[a],twitch:r||null,isStreaming:d,streamInfo:h,isLive:t,isEven:l%2===0},s.id)})})]})]})};export{qe as default};

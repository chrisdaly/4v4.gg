import{u as ce,r as n,j as e,W as oe,O as ie}from"./index-B9cDvMpz.js";const B="https://4v4gg-chat-relay.fly.dev",me=[1,10,50,100],de=m=>!m||m.length!==2?"":String.fromCodePoint(...[...m.toUpperCase()].map(r=>127462+r.charCodeAt(0)-65)),pe=m=>{if(!m)return"--:--:--";const r=m.getHours().toString().padStart(2,"0"),v=m.getMinutes().toString().padStart(2,"0"),y=m.getSeconds().toString().padStart(2,"0");return`${r}:${v}:${y}`},ue=m=>m?m.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"}):"",he=m=>{const r=m.getHours(),v=m.getMinutes();return`${r}:${v<10?"0"+v:v}`},ge=()=>{const m=new Date;return m.setDate(m.getDate()-1),m.toISOString().slice(0,16)},ye=()=>new Date().toISOString().slice(0,16),fe=({events:m})=>e.jsxs("div",{className:"replay-panel replay-events",children:[e.jsxs("div",{className:"replay-section-header",children:[e.jsx("span",{className:"replay-section-title",children:"Activity"}),e.jsxs("span",{className:"replay-section-count",children:[m.length," events"]})]}),e.jsxs("div",{className:"event-feed-list",children:[m.length===0&&e.jsx("div",{className:"replay-empty",children:"No events yet..."}),m.map((r,v)=>e.jsxs("div",{className:"event-item",children:[e.jsx("span",{className:`event-dot event-${r.type}`}),e.jsxs("div",{className:"event-body",children:[e.jsxs("div",{className:"event-main",children:[r.country&&e.jsx("span",{className:"event-flag",children:de(r.country)}),e.jsx("span",{className:"event-name",children:r.type==="game_start"?(r.players||[]).slice(0,2).join(", ")+((r.players||[]).length>2?` +${r.players.length-2}`:""):r.type==="game_end"?"Game ended":r.player}),e.jsx("span",{className:"event-time",children:he(r.time)})]}),e.jsxs("div",{className:"event-detail",children:[r.type==="join"&&"joined",r.type==="leave"&&"left",r.type==="game_start"&&(r.map?`started on ${r.map}`:"started a game"),r.type==="game_end"&&((r.results||[]).length>0?e.jsx("div",{className:"event-game-results",children:[...r.results].sort((y,M)=>M.delta-y.delta).map((y,M)=>e.jsxs("div",{className:"event-game-row",children:[e.jsx("span",{className:"event-game-name",children:y.name}),e.jsxs("span",{className:y.delta>0?"event-delta-gain":"event-delta-loss",children:[y.delta>0?"+":"",y.delta]})]},M))}):e.jsx("span",{children:(r.players||[]).slice(0,4).join(", ")}))]})]})]},`${r.type}-${v}`))]})]}),be=()=>{var Y;const m=ce(),[r,v]=n.useState(ge),[y,M]=n.useState(ye),[l,O]=n.useState([]),[_,z]=n.useState(!1),[G,H]=n.useState(null),[k,J]=n.useState(null),[T,C]=n.useState(!1),[E,K]=n.useState(10),[b,F]=n.useState(0),[P,N]=n.useState(null),S=n.useRef(!1),W=n.useRef(E),D=n.useRef(0),I=n.useRef(null),x=n.useRef(null),[U,$]=n.useState(new Map),[f,R]=n.useState(new Map),[Q,j]=n.useState([]);n.useEffect(()=>{fetch(`${B}/api/chat/events/summary`).then(a=>a.json()).then(J).catch(()=>{})},[]);const X=n.useCallback(async()=>{z(!0),H(null),C(!1),S.current=!1;try{const a=new Date(r).toISOString(),s=new Date(y).toISOString(),t=await fetch(`${B}/api/chat/events?from=${encodeURIComponent(a)}&to=${encodeURIComponent(s)}`);if(!t.ok)throw new Error(`HTTP ${t.status}`);const c=await t.json();O(c.events||[]),A()}catch(a){H(a.message),O([])}finally{z(!1)}},[r,y]),A=n.useCallback(()=>{F(0),D.current=0,N(null),$(new Map),R(new Map),j([]),x.current=null},[]);n.useEffect(()=>{W.current=E},[E]),n.useEffect(()=>{S.current=T},[T]);const q=n.useCallback(a=>{const{type:s,payload:t,timestamp:c}=a,o=new Date(c);switch(s){case"join":{$(p=>{const d=new Map(p);return d.set(t.battleTag,{battleTag:t.battleTag,name:t.name||t.battleTag.split("#")[0],clanTag:t.clanTag||""}),d}),j(p=>[{type:"join",player:t.name||t.battleTag.split("#")[0],tag:t.battleTag,country:null,time:o},...p].slice(0,100));break}case"leave":{$(p=>{const d=new Map(p);return d.delete(t.battleTag),d}),j(p=>[{type:"leave",player:t.name||t.battleTag.split("#")[0],tag:t.battleTag,country:null,time:o},...p].slice(0,100));break}case"game_start":{R(d=>{const i=new Map(d);return i.set(t.matchId,t),i});const p=(t.players||[]).map(d=>{var i;return d.name||((i=d.battleTag)==null?void 0:i.split("#")[0])});j(d=>[{type:"game_start",players:p,map:t.map,matchId:t.matchId,time:o},...d].slice(0,100));break}case"game_end":{R(i=>{const u=new Map(i);return u.delete(t.matchId),u});const p=(t.players||[]).map(i=>{var u;return i.name||((u=i.battleTag)==null?void 0:u.split("#")[0])}),d=(t.players||[]).filter(i=>i.oldMmr!=null&&i.currentMmr!=null&&i.oldMmr!==i.currentMmr).map(i=>{var u;return{name:i.name||((u=i.battleTag)==null?void 0:u.split("#")[0]),delta:Math.round(i.currentMmr-i.oldMmr),mmr:i.currentMmr}});j(i=>[{type:"game_end",players:p,results:d,matchId:t.matchId,time:o},...i].slice(0,100));break}}},[]);n.useEffect(()=>{if(!T||l.length===0)return;const a=s=>{if(S.current){if(x.current!=null){const c=(s-x.current)*W.current;let o=D.current;if(o<l.length){const p=new Date(l[o].timestamp),d=new Date(p.getTime()+c);for(;o<l.length&&!(new Date(l[o].timestamp)>d);)q(l[o]),o++;D.current=o,F(o),o<l.length?N(new Date(l[o].timestamp)):(N(new Date(l[l.length-1].timestamp)),C(!1),S.current=!1)}}x.current=s,S.current&&(I.current=requestAnimationFrame(a))}};return x.current=null,I.current=requestAnimationFrame(a),()=>{I.current&&cancelAnimationFrame(I.current)}},[T,l,q]);const Z=n.useCallback(a=>{var p;const s=parseInt(a.target.value,10),t=new Map,c=new Map,o=[];for(let d=0;d<s&&d<l.length;d++){const i=l[d],{type:u,payload:h,timestamp:le}=i,re=new Date(le);switch(u){case"join":t.set(h.battleTag,{battleTag:h.battleTag,name:h.name||h.battleTag.split("#")[0],clanTag:h.clanTag||""});break;case"leave":t.delete(h.battleTag);break;case"game_start":c.set(h.matchId,h);break;case"game_end":c.delete(h.matchId);break}o.length>=50&&o.pop(),o.unshift({type:u,player:u==="join"||u==="leave"?h.name||((p=h.battleTag)==null?void 0:p.split("#")[0]):void 0,players:u==="game_start"||u==="game_end"?(h.players||[]).map(g=>{var w;return g.name||((w=g.battleTag)==null?void 0:w.split("#")[0])}):void 0,results:u==="game_end"?(h.players||[]).filter(g=>g.oldMmr!=null&&g.currentMmr!=null&&g.oldMmr!==g.currentMmr).map(g=>{var w;return{name:g.name||((w=g.battleTag)==null?void 0:w.split("#")[0]),delta:Math.round(g.currentMmr-g.oldMmr),mmr:g.currentMmr}}):void 0,map:h.map,matchId:h.matchId,time:re})}$(t),R(c),j(o),F(s),D.current=s,x.current=null,s<l.length?N(new Date(l[s].timestamp)):l.length>0&&N(new Date(l[l.length-1].timestamp))},[l]),ee=n.useCallback(()=>{if(b>=l.length&&l.length>0){A(),setTimeout(()=>C(!0),50);return}C(a=>!a)},[b,l.length,A]),te=n.useCallback(a=>{a&&m.push(`/player/${encodeURIComponent(a)}`)},[m]),ae=n.useMemo(()=>[...f.values()].map(a=>({id:a.matchId,mapName:a.map,teams:[{players:(a.players||[]).filter((s,t)=>t<4).map(s=>({battleTag:s.battleTag,oldMmr:s.oldMmr||s.currentMmr||0,currentMmr:s.currentMmr||s.oldMmr||0,race:s.race}))},{players:(a.players||[]).filter((s,t)=>t>=4).map(s=>({battleTag:s.battleTag,oldMmr:s.oldMmr||s.currentMmr||0,currentMmr:s.currentMmr||s.oldMmr||0,race:s.race}))}]})),[f]),L=n.useMemo(()=>{const a=new Set,s=[];for(const[t,c]of U)a.add(t),s.push({battleTag:t,name:c.name||t.split("#")[0],mmr:null,race:null,wins:0,losses:0,rank:null});for(const t of f.values())for(const c of t.players||[])if(c.battleTag&&!a.has(c.battleTag)){a.add(c.battleTag);const o=c.currentMmr||c.oldMmr||0;s.push({battleTag:c.battleTag,name:c.name||c.battleTag.split("#")[0],mmr:o>0?o:null,race:c.race??null,wins:0,losses:0,rank:null})}return s.filter(t=>t.mmr!=null)},[U,f]),V=n.useMemo(()=>{const a=new Set;for(const t of f.values())for(const c of t.players||[])c.battleTag&&a.add(c.battleTag);const s=new Map;for(const t of f.values())for(const c of t.players||[]){if(!c.country||!c.battleTag)continue;const o=c.country.toUpperCase();s.has(o)||s.set(o,{online:0,inGame:0}),s.get(o).inGame++}return s},[f]),se=n.useMemo(()=>{const a=[];for(const s of f.values())for(const t of s.players||[]){if(!t.country||!t.battleTag)continue;const c=t.currentMmr||t.oldMmr||null;a.push({battleTag:t.battleTag,name:t.name||t.battleTag.split("#")[0],country:t.country.toUpperCase(),mmr:c,inGame:!0})}return a},[f]),ne=l.length>0?b/l.length*100:0;return e.jsxs("div",{className:"replay",children:[e.jsxs("div",{className:"replay-controls",children:[e.jsxs("div",{className:"replay-controls-row",children:[e.jsxs("div",{className:"replay-date-inputs",children:[e.jsxs("label",{children:[e.jsx("span",{className:"replay-label",children:"From"}),e.jsx("input",{type:"datetime-local",value:r,onChange:a=>v(a.target.value)})]}),e.jsxs("label",{children:[e.jsx("span",{className:"replay-label",children:"To"}),e.jsx("input",{type:"datetime-local",value:y,onChange:a=>M(a.target.value)})]}),e.jsx("button",{className:"replay-btn replay-btn-load",onClick:X,disabled:_,children:_?"Loading...":"Load"})]}),e.jsxs("div",{className:"replay-playback",children:[e.jsx("button",{className:"replay-btn replay-btn-play",onClick:ee,disabled:l.length===0,children:T?"⏸":b>=l.length&&l.length>0?"⟳":"▶"}),e.jsx("div",{className:"replay-speed-btns",children:me.map(a=>e.jsxs("button",{className:`replay-btn replay-btn-speed ${E===a?"active":""}`,onClick:()=>K(a),children:[a,"x"]},a))})]}),e.jsxs("div",{className:"replay-clock",children:[e.jsx("span",{className:"replay-clock-date",children:P?ue(P):""}),e.jsx("span",{className:"replay-clock-time",children:pe(P)})]}),e.jsxs("div",{className:"replay-stats",children:[e.jsxs("span",{children:[U.size," chatting"]}),e.jsxs("span",{children:[f.size," games"]}),e.jsxs("span",{children:[b,"/",l.length]})]})]}),l.length>0&&e.jsxs("div",{className:"replay-scrubber",children:[e.jsx("input",{type:"range",min:0,max:l.length,value:b,onChange:Z,className:"replay-range"}),e.jsx("div",{className:"replay-progress-bar",style:{width:`${ne}%`}})]}),G&&e.jsx("div",{className:"replay-error",children:G}),k&&!l.length&&!_&&e.jsx("div",{className:"replay-summary",children:k.totalEvents>0?`${k.totalEvents.toLocaleString()} events recorded · ${((Y=k.days)==null?void 0:Y.length)||0} days`:"No events recorded yet. Events will appear once the server starts recording."})]}),e.jsxs("div",{className:"replay-viz",children:[e.jsxs("div",{className:"replay-panel replay-world-map",children:[e.jsxs("div",{className:"replay-section-header",children:[e.jsx("span",{className:"replay-section-title",children:"World Map"}),e.jsxs("span",{className:"replay-section-count",children:[V.size," countries"]})]}),e.jsx(oe,{playerCountries:V,players:se})]}),L.length>0&&e.jsxs("div",{className:"replay-panel replay-mmr-chart",children:[e.jsxs("div",{className:"replay-section-header",children:[e.jsx("span",{className:"replay-section-title",children:"MMR Distribution"}),e.jsxs("span",{className:"replay-section-count",children:[L.length," players"]})]}),e.jsx(ie,{players:L,matches:ae,onPlayerClick:te})]}),e.jsx(fe,{events:Q})]})]})};export{be as default};

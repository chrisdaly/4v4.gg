import{R as Se,j as e,G as je,h as be,L as ke,F as Ce,r as n,i as ue,P as Re,k as Le,l as xe,m as Te,n as $e,a as ve,o as Pe,f as De,p as Ee,q as Ie,s as Fe}from"./index-DgCB13An.js";import{b as ye}from"./index-FftCYySV.js";const Me=({rank:i,sparklineData:C,session:o,detectedRace:Y,twitch:_,isStreaming:Z,streamInfo:x,isLive:N,isEven:ee})=>{var X,v,T,y,f,O,$,m;const{name:R,mmr:E,wins:I,losses:H,winrate:L,race:se}=i.player||{},F=((v=(X=i.playersInfo)==null?void 0:X[0])==null?void 0:v.battleTag)||((f=(y=(T=i.player)==null?void 0:T.playerIds)==null?void 0:y[0])==null?void 0:f.battleTag)||"",M=Y??se??(($=(O=i.playersInfo)==null?void 0:O[0])==null?void 0:$.calculatedRace),W=be[M],J=i.rankNumber,G=L?Math.round(L*1e4)/100:0,S=F.replace("#","%23");return e.jsxs("div",{className:`ladder-row ${N?"is-live":""} ${ee?"even":"odd"}`,children:[e.jsxs("div",{className:"col-rank",children:[N&&e.jsx(je,{className:"in-game-icon"}),e.jsx("span",{className:"rank-number",children:J})]}),e.jsxs("div",{className:"col-player",children:[e.jsx("img",{src:W,alt:"",className:"player-race-icon"}),e.jsx(ke,{to:`/player/${S}`,className:"player-name-link",children:R}),_&&Z&&e.jsx("a",{href:`https://twitch.tv/${_}`,target:"_blank",rel:"noopener noreferrer",className:"twitch-link",title:`${(x==null?void 0:x.title)||"Streaming"} (${(x==null?void 0:x.viewerCount)||0} viewers)`,children:e.jsx(Ce,{className:"twitch-icon"})})]}),e.jsx("div",{className:"col-mmr",children:e.jsx("span",{className:"mmr-value",children:E})}),e.jsxs("div",{className:"col-record",children:[e.jsx("span",{className:"wins",children:I}),e.jsx("span",{className:"record-separator",children:"-"}),e.jsx("span",{className:"losses",children:H})]}),e.jsx("div",{className:"col-winrate",children:e.jsxs("span",{className:G>=50?"winrate-positive":"winrate-negative",children:[G.toFixed(1),"%"]})}),e.jsx("div",{className:"col-session",children:o?e.jsxs("div",{className:"session-inline-row",children:[e.jsxs("span",{className:"session-record",children:[e.jsx("span",{className:"wins",children:o.wins}),e.jsx("span",{className:"record-separator",children:"-"}),e.jsx("span",{className:"losses",children:o.losses})]}),e.jsxs("span",{className:`session-mmr ${o.mmrChange>=0?"positive":"negative"}`,children:[o.mmrChange>=0?"+":"",o.mmrChange]}),((m=o.form)==null?void 0:m.length)>0&&e.jsx("div",{className:"form-dots-inline",children:o.form.map((ae,z)=>e.jsx("span",{className:`form-dot ${ae?"win":"loss"}`},z))})]}):e.jsx("span",{className:"session-none",children:"-"})}),e.jsx("div",{className:"col-form",children:C.length>0?e.jsx(ye.Sparklines,{data:C.slice(-50),width:120,height:24,children:e.jsx(ye.SparklinesLine,{style:{strokeWidth:1.5,stroke:"var(--gold)",fill:"none"}})}):e.jsx("div",{className:"sparkline-placeholder"})})]})},We=Se.memo(Me),ze=()=>{const[i,C]=n.useState(null),[o,Y]=n.useState(0),[_,Z]=n.useState([]),[x,N]=n.useState([]),[ee,R]=n.useState(!0),[E,I]=n.useState({}),[H,L]=n.useState({}),[se,F]=n.useState({}),[M,W]=n.useState({}),[J,G]=n.useState(new Map),[S,X]=n.useState(new Set),[v,T]=n.useState(""),[y,f]=n.useState(null),[O,$]=n.useState(!1),[m,ae]=n.useState("rank"),[z,ce]=n.useState("asc");n.useEffect(()=>{(async()=>{try{const l=await Le();if(l&&l.length>0){Z(l);const a=l[0].id;C(a);const t=xe(0,a);t&&(N(t),R(!1))}}catch(l){console.error("Failed to fetch seasons:",l),C(24)}})()},[]),n.useEffect(()=>{const s=async()=>{try{const a=await Te(),t=new Set;a!=null&&a.matches&&a.matches.forEach(r=>{var d;(d=r.teams)==null||d.forEach(h=>{var u;(u=h.players)==null||u.forEach(g=>{g.battleTag&&t.add(g.battleTag.toLowerCase())})})}),X(t)}catch(a){console.error("Failed to fetch ongoing games:",a)}};s();const l=setInterval(s,3e4);return()=>clearInterval(l)},[]),n.useEffect(()=>{const s=Object.values(M).filter(Boolean);if(s.length===0){G(new Map);return}const l=async()=>{const t=await $e(s);G(t)};l();const a=setInterval(l,6e4);return()=>clearInterval(a)},[M]),n.useEffect(()=>{if(i===null)return;const s=`ladderPlayerData:${o}:${i}`;(async()=>{const a=xe(o,i),t=ve.get(s);a&&a.length>0?(N(a),R(!1),t&&(I(t.sparklines||{}),L(t.sessions||{}),F(t.races||{}),W(t.twitch||{}))):(R(!0),I({}),L({}),F({}),W({}));try{const r=await Pe(o,i);N(r),fe(r,i,s)}catch(r){console.error("Failed to fetch ladder:",r),N([])}finally{R(!1)}})()},[i,o]);const fe=async(s,l,a)=>{const r={},d={},h={},u={};for(let g=0;g<s.length;g+=5){const k=s.slice(g,g+5).map(async c=>{var V,q,K;const w=(V=c.playersInfo[0])==null?void 0:V.battleTag,A=((q=c.player)==null?void 0:q.race)??((K=c.playersInfo[0])==null?void 0:K.calculatedRace);if(!w)return null;let B=[];try{B=await Ee(w,l)}catch{}let Q=null;try{const p=await Ie(w,A);Q=(p==null?void 0:p.session)||null}catch{}let U=null;try{const p=await Fe(w);U=(p==null?void 0:p.twitch)||null}catch{}return{battleTag:w,sparkline:B,session:Q,detectedRace:A,twitch:U}});(await Promise.all(k)).forEach(c=>{c&&(r[c.battleTag]=c.sparkline,d[c.battleTag]=c.session,c.detectedRace!==void 0&&c.detectedRace!==null&&(h[c.battleTag]=c.detectedRace),c.twitch&&(u[c.battleTag]=c.twitch))}),I(c=>({...c,...r})),L(c=>({...c,...d})),F(c=>({...c,...h})),W(c=>({...c,...u}))}ve.set(a,{sparklines:r,sessions:d,races:h,twitch:u},300*1e3)},we=s=>{C(parseInt(s.target.value,10))},Ne=s=>{Y(parseInt(s.target.value,10)),T(""),f(null)};n.useEffect(()=>{if(!v||v.length<2){f(null),$(!1);return}const l=setTimeout(async()=>{$(!0);try{const t=await(await fetch(`https://website-backend.w3champions.com/api/ladder/search?gateWay=${De}&searchFor=${encodeURIComponent(v)}&gameMode=4&season=${i}`)).json();f(t||[])}catch(a){console.error("Search failed:",a),f([])}finally{$(!1)}},300);return()=>clearTimeout(l)},[v,i]);const b=s=>{m===s?ce(z==="asc"?"desc":"asc"):(ae(s),ce(s==="rank"||s==="race"?"asc":"desc"))},ne=y!==null?y:x,re=s=>{var r,d;const l=(d=(r=s.playersInfo)==null?void 0:r[0])==null?void 0:d.battleTag,a=H[l];if((a==null?void 0:a.mmrChange)!==void 0)return a.mmrChange;const t=E[l];if((t==null?void 0:t.length)>=2){const h=t.slice(-10);return h[h.length-1]-h[0]}return 0},ie=s=>{var a,t;const l=(t=(a=s.playersInfo)==null?void 0:a[0])==null?void 0:t.battleTag;return l&&S.has(l.toLowerCase())?1:0},oe=n.useMemo(()=>[...ne].sort((s,l)=>{var r,d,h,u,g,P,k,D,c,w,A,B,Q,U,V,q,K,p,he,me;let a,t;switch(m){case"rank":a=s.rankNumber,t=l.rankNumber;break;case"mmr":a=((r=s.player)==null?void 0:r.mmr)||0,t=((d=l.player)==null?void 0:d.mmr)||0;break;case"wins":a=((h=s.player)==null?void 0:h.wins)||0,t=((u=l.player)==null?void 0:u.wins)||0;break;case"losses":a=((g=s.player)==null?void 0:g.losses)||0,t=((P=l.player)==null?void 0:P.losses)||0;break;case"winrate":{const te=((k=s.player)==null?void 0:k.wins)||0,ge=((D=s.player)==null?void 0:D.losses)||0,le=((c=l.player)==null?void 0:c.wins)||0,pe=((w=l.player)==null?void 0:w.losses)||0;a=te+ge>0?te/(te+ge):0,t=le+pe>0?le/(le+pe):0;break}case"games":a=(((A=s.player)==null?void 0:A.wins)||0)+(((B=s.player)==null?void 0:B.losses)||0),t=(((Q=l.player)==null?void 0:Q.wins)||0)+(((U=l.player)==null?void 0:U.losses)||0);break;case"race":a=((V=s.player)==null?void 0:V.race)??((K=(q=s.playersInfo)==null?void 0:q[0])==null?void 0:K.calculatedRace)??99,t=((p=l.player)==null?void 0:p.race)??((me=(he=l.playersInfo)==null?void 0:he[0])==null?void 0:me.calculatedRace)??99;break;case"momentum":a=re(s),t=re(l);break;case"live":a=ie(s),t=ie(l);break;default:return 0}return z==="asc"?a-t:t-a}),[ne,m,z,E,S]),de=n.useMemo(()=>x.filter(s=>{var a,t;const l=(t=(a=s.playersInfo)==null?void 0:a[0])==null?void 0:t.battleTag;return l&&S.has(l.toLowerCase())}).length,[x,S]),j=ue.find(s=>s.id===o);return e.jsx(Re,{maxWidth:"1000px",header:e.jsxs("div",{className:"ladder-header",children:[e.jsx("div",{className:"ladder-title-section",children:y!==null?e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"ladder-title",children:"Search Results"}),e.jsx("div",{className:"ladder-stats",children:e.jsxs("span",{className:"stat-item",children:[y.length," players found"]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"ladder-league-title",children:[e.jsx("img",{src:j==null?void 0:j.icon,alt:"",className:"league-icon-title"}),e.jsx("h1",{className:"ladder-title",children:j==null?void 0:j.name})]}),e.jsxs("div",{className:"ladder-stats",children:[e.jsxs("span",{className:"stat-item",children:[x.length," players"]}),de>0&&e.jsxs("span",{className:"stat-item in-game",children:[e.jsx(je,{className:"in-game-icon-small"}),de," in game"]})]})]})}),e.jsxs("div",{className:"ladder-controls",children:[e.jsxs("div",{className:"ladder-search",children:[e.jsx("input",{type:"text",placeholder:"Search all leagues...",value:v,onChange:s=>T(s.target.value)}),v&&e.jsx("button",{className:"search-clear",onClick:()=>{T(""),f(null)},children:"Ã—"})]}),e.jsxs("div",{className:"ladder-selectors",children:[e.jsxs("div",{className:"league-selector",children:[e.jsx("img",{src:j==null?void 0:j.icon,alt:"",className:"league-icon"}),e.jsx("select",{id:"league-select",value:o,onChange:Ne,disabled:y!==null,children:ue.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsx("div",{className:"season-selector",children:e.jsx("select",{id:"season-select",value:i||"",onChange:we,children:_.map(s=>e.jsxs("option",{value:s.id,children:["S",s.id]},s.id))})})]})]})]}),children:ee||O?e.jsxs("div",{className:"ladder-loading",children:[e.jsx("div",{className:"loader-spinner lg"}),e.jsx("span",{className:"loader-text",children:O?"Searching":"Loading ladder"})]}):e.jsxs("div",{className:"ladder-table",children:[e.jsxs("div",{className:"ladder-header-row",children:[e.jsx("div",{className:`col-rank sortable ${m==="rank"?"active":""}`,onClick:()=>b("rank"),children:"Rank"}),e.jsx("div",{className:`col-player sortable ${m==="race"?"active":""}`,onClick:()=>b("race"),children:"Player"}),e.jsx("div",{className:`col-mmr sortable ${m==="mmr"?"active":""}`,onClick:()=>b("mmr"),children:"MMR"}),e.jsx("div",{className:`col-record sortable ${m==="games"?"active":""}`,onClick:()=>b("games"),children:"Record"}),e.jsx("div",{className:`col-winrate sortable ${m==="winrate"?"active":""}`,onClick:()=>b("winrate"),children:"Win%"}),e.jsx("div",{className:`col-session sortable ${m==="momentum"?"active":""}`,onClick:()=>b("momentum"),children:"Session"}),e.jsx("div",{className:`col-form sortable ${m==="live"?"active":""}`,onClick:()=>b("live"),children:"Form"})]}),oe.length===0?e.jsx("div",{className:"ladder-no-results",children:y!==null?`No players found matching "${v}"`:"No players in this league"}):oe.map((s,l)=>{var u,g,P,k,D;const a=((g=(u=s.playersInfo)==null?void 0:u[0])==null?void 0:g.battleTag)||((D=(k=(P=s.player)==null?void 0:P.playerIds)==null?void 0:k[0])==null?void 0:D.battleTag),t=a&&S.has(a.toLowerCase()),r=M[a],d=r&&J.has(r.toLowerCase()),h=d?J.get(r.toLowerCase()):null;return e.jsx(We,{rank:s,sparklineData:E[a]||[],session:H[a]||null,detectedRace:se[a],twitch:r||null,isStreaming:d,streamInfo:h,isLive:t,isEven:l%2===0},s.id)})]})})};export{ze as default};

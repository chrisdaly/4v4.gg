import{u as ye,r as s,j as n,W as be,U as Me,V as ve}from"./index-6R-bl_KJ.js";const re="https://4v4gg-chat-relay.fly.dev",Te=[1,10,50,100],Se=[{label:"Last hour",hours:1},{label:"Last 6h",hours:6},{label:"Last 24h",hours:24},{label:"Last 3 days",hours:72}],xe=d=>{if(!d)return"--:--:--";const T=d.getHours().toString().padStart(2,"0"),w=d.getMinutes().toString().padStart(2,"0"),S=d.getSeconds().toString().padStart(2,"0");return`${T}:${w}:${S}`},je=d=>d?d.toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"}):"",z=d=>{const T=d.getFullYear(),w=String(d.getMonth()+1).padStart(2,"0"),S=String(d.getDate()).padStart(2,"0"),I=String(d.getHours()).padStart(2,"0"),c=String(d.getMinutes()).padStart(2,"0");return`${T}-${w}-${S}T${I}:${c}`},we=()=>{const d=new Date;return d.setHours(d.getHours()-1),z(d)},ke=()=>z(new Date),Ee=()=>{var se;const d=ye(),[T,w]=s.useState(we),[S,I]=s.useState(ke),[c,B]=s.useState([]),[$,J]=s.useState(!1),[K,Q]=s.useState(null),[P,le]=s.useState(null),[_,k]=s.useState(!1),[M,ce]=s.useState(10),[N,G]=s.useState(0),[F,L]=s.useState(null),x=s.useRef(!1),X=s.useRef(M),D=s.useRef(0),v=s.useRef(null),E=s.useRef(null),j=s.useRef(null),[W,A]=s.useState(new Map),[b,U]=s.useState(new Map),[oe,C]=s.useState([]),me=s.useMemo(()=>{var a;let t=1/0,l=-1/0;for(const e of c)if(!(e.type!=="game_start"&&e.type!=="game_end"))for(const u of((a=e.payload)==null?void 0:a.players)||[]){const m=u.currentMmr||u.oldMmr;m!=null&&m>0&&(m<t&&(t=m),m>l&&(l=m))}return t===1/0?null:[t-50,l+50]},[c]),Z=s.useMemo(()=>M<=1?1:M<=10?.3:M<=50?.1:.05,[M]);s.useEffect(()=>{fetch(`${re}/api/chat/events/summary`).then(t=>t.json()).then(le).catch(()=>{})},[]);const q=s.useCallback(async(t,l)=>{J(!0),Q(null),k(!1),x.current=!1;try{const a=new Date(t||T).toISOString(),e=new Date(l||S).toISOString(),u=await fetch(`${re}/api/chat/events?from=${encodeURIComponent(a)}&to=${encodeURIComponent(e)}`);if(!u.ok)throw new Error(`HTTP ${u.status}`);const o=((await u.json()).events||[]).map(i=>({...i,_ms:new Date(i.timestamp).getTime()}));B(o),V()}catch(a){Q(a.message),B([])}finally{J(!1)}},[T,S]),ee=s.useCallback(t=>{const l=new Date,a=new Date(l.getTime()-t*60*60*1e3);w(z(a)),I(z(l)),q(a.toISOString(),l.toISOString())},[q]),te=s.useRef(!1);s.useEffect(()=>{te.current||(te.current=!0,ee(1))},[]);const V=s.useCallback(()=>{G(0),D.current=0,L(null),j.current=null,A(new Map),U(new Map),C([]),E.current=null},[]);s.useEffect(()=>{X.current=M},[M]),s.useEffect(()=>{x.current=_},[_]);const ae=s.useCallback((t,l)=>{const{type:a,payload:e,_ms:u}=t,m=new Date(u);switch(a){case"join":{A(o=>{const i=new Map(o);return i.set(e.battleTag,{battleTag:e.battleTag,name:e.name||e.battleTag.split("#")[0],clanTag:e.clanTag||""}),i}),C(o=>[{type:"join",player:e.name||e.battleTag.split("#")[0],tag:e.battleTag,country:null,time:m,rawIdx:l},...o].slice(0,100));break}case"leave":{A(o=>{const i=new Map(o);return i.delete(e.battleTag),i}),C(o=>[{type:"leave",player:e.name||e.battleTag.split("#")[0],tag:e.battleTag,country:null,time:m,rawIdx:l},...o].slice(0,100));break}case"game_start":{U(g=>{const r=new Map(g);return r.set(e.matchId,e),r});const o=(e.players||[]).map(g=>{var r;return{name:g.name||((r=g.battleTag)==null?void 0:r.split("#")[0]),battleTag:g.battleTag,mmr:g.currentMmr||g.oldMmr||0}}),i=o.map(g=>g.mmr).filter(g=>g>0),p=i.length>0?Math.round(i.reduce((g,r)=>g+r,0)/i.length):null;C(g=>[{type:"game_start",gamePlayers:o,avgMmr:p,matchId:e.matchId,time:m,rawIdx:l},...g].slice(0,100));break}case"game_end":{U(r=>{const h=new Map(r);return h.delete(e.matchId),h});const o=(e.players||[]).map(r=>{var h;return{name:r.name||((h=r.battleTag)==null?void 0:h.split("#")[0]),battleTag:r.battleTag,mmr:r.currentMmr||r.oldMmr||0}}),i=o.map(r=>r.mmr).filter(r=>r>0),p=i.length>0?Math.round(i.reduce((r,h)=>r+h,0)/i.length):null,g=(e.players||[]).map(r=>{var h;return{name:r.name||((h=r.battleTag)==null?void 0:h.split("#")[0]),tag:r.battleTag,delta:r.oldMmr!=null&&r.currentMmr!=null&&r.oldMmr!==r.currentMmr?Math.round(r.currentMmr-r.oldMmr):null,mmr:r.currentMmr||r.oldMmr||0}});C(r=>[{type:"game_end",gamePlayers:o,results:g,avgMmr:p,matchId:e.matchId,time:m,rawIdx:l},...r].slice(0,100));break}}},[]);s.useEffect(()=>{if(!_||c.length===0)return;const t=D.current;j.current==null&&t<c.length&&(j.current=c[t]._ms);const l=a=>{if(x.current){if(E.current!=null){const u=(a-E.current)*X.current;j.current+=u;const m=j.current;let o=D.current;for(;o<c.length&&!(c[o]._ms>m);)ae(c[o],o),o++;D.current=o,G(o),L(new Date(m)),o>=c.length&&(k(!1),x.current=!1)}E.current=a,x.current&&(v.current=requestAnimationFrame(l))}};return E.current=null,v.current=requestAnimationFrame(l),()=>{v.current&&cancelAnimationFrame(v.current)}},[_,c,ae]);const H=s.useCallback(t=>{var u;const l=new Map,a=new Map,e=[];for(let m=0;m<t&&m<c.length;m++){const o=c[m],{type:i,payload:p,_ms:g}=o,r=new Date(g);switch(i){case"join":l.set(p.battleTag,{battleTag:p.battleTag,name:p.name||p.battleTag.split("#")[0],clanTag:p.clanTag||""});break;case"leave":l.delete(p.battleTag);break;case"game_start":a.set(p.matchId,p);break;case"game_end":a.delete(p.matchId);break}const h={type:i,time:r,rawIdx:m,matchId:p.matchId};if((i==="join"||i==="leave")&&(h.player=p.name||((u=p.battleTag)==null?void 0:u.split("#")[0]),h.tag=p.battleTag),i==="game_start"||i==="game_end"){const f=(p.players||[]).map(y=>{var O;return{name:y.name||((O=y.battleTag)==null?void 0:O.split("#")[0]),battleTag:y.battleTag,mmr:y.currentMmr||y.oldMmr||0}}),R=f.map(y=>y.mmr).filter(y=>y>0);h.gamePlayers=f,h.avgMmr=R.length>0?Math.round(R.reduce((y,O)=>y+O,0)/R.length):null}i==="game_end"&&(h.results=(p.players||[]).map(f=>{var R;return{name:f.name||((R=f.battleTag)==null?void 0:R.split("#")[0]),tag:f.battleTag,delta:f.oldMmr!=null&&f.currentMmr!=null&&f.oldMmr!==f.currentMmr?Math.round(f.currentMmr-f.oldMmr):null,mmr:f.currentMmr||f.oldMmr||0}})),e.length>=50&&e.pop(),e.unshift(h)}if(A(l),U(a),C(e),G(t),D.current=t,E.current=null,t<c.length)L(new Date(c[t]._ms)),j.current=c[t]._ms;else if(c.length>0){const m=c[c.length-1];L(new Date(m._ms)),j.current=m._ms}},[c]),ie=s.useCallback(t=>{k(!1),x.current=!1,v.current&&cancelAnimationFrame(v.current),H(parseInt(t.target.value,10))},[H]),ue=s.useCallback(t=>{k(!1),x.current=!1,v.current&&cancelAnimationFrame(v.current),H(t)},[H]),de=s.useCallback(()=>{if(N>=c.length&&c.length>0){V(),setTimeout(()=>k(!0),50);return}k(t=>!t)},[N,c.length,V]),pe=s.useCallback(t=>{t&&d.push(`/player/${encodeURIComponent(t)}`)},[d]),ge=s.useMemo(()=>[...b.values()].map(t=>{const l=[],a=[];for(const e of t.players||[]){const u={battleTag:e.battleTag,oldMmr:e.oldMmr||e.currentMmr||0,currentMmr:e.currentMmr||e.oldMmr||0,race:e.race};(e.teamIdx===1?a:l).push(u)}return{id:t.matchId,mapName:t.map,teams:[{players:l},{players:a}]}}),[b]),Y=s.useMemo(()=>{const t=new Set,l=[];for(const[a,e]of W)t.add(a),l.push({battleTag:a,name:e.name||a.split("#")[0],mmr:null,race:null,wins:0,losses:0,rank:null});for(const a of b.values())for(const e of a.players||[])if(e.battleTag&&!t.has(e.battleTag)){t.add(e.battleTag);const u=e.currentMmr||e.oldMmr||0;l.push({battleTag:e.battleTag,name:e.name||e.battleTag.split("#")[0],mmr:u>0?u:null,race:e.race??null,wins:0,losses:0,rank:null})}return l.filter(a=>a.mmr!=null)},[W,b]),ne=s.useMemo(()=>{const t=new Set;for(const a of b.values())for(const e of a.players||[])e.battleTag&&t.add(e.battleTag);const l=new Map;for(const a of b.values())for(const e of a.players||[]){if(!e.country||!e.battleTag)continue;const u=e.country.toUpperCase();l.has(u)||l.set(u,{online:0,inGame:0}),l.get(u).inGame++}return l},[b]),he=s.useMemo(()=>{const t=[];for(const l of b.values())for(const a of l.players||[]){if(!a.country||!a.battleTag)continue;const e=a.currentMmr||a.oldMmr||null;t.push({battleTag:a.battleTag,name:a.name||a.battleTag.split("#")[0],country:a.country.toUpperCase(),mmr:e,inGame:!0})}return t},[b]),fe=c.length>0?N/c.length*100:0;return n.jsxs("div",{className:"replay",children:[n.jsxs("div",{className:"replay-controls",children:[n.jsxs("div",{className:"replay-controls-row",children:[n.jsx("div",{className:"replay-presets",children:Se.map(t=>n.jsx("button",{className:"replay-btn replay-btn-preset",onClick:()=>ee(t.hours),disabled:$,children:t.label},t.hours))}),n.jsxs("div",{className:"replay-date-inputs",children:[n.jsxs("label",{children:[n.jsx("span",{className:"replay-label",children:"From"}),n.jsx("input",{type:"datetime-local",value:T,onChange:t=>w(t.target.value)})]}),n.jsxs("label",{children:[n.jsx("span",{className:"replay-label",children:"To"}),n.jsx("input",{type:"datetime-local",value:S,onChange:t=>I(t.target.value)})]}),n.jsx("button",{className:"replay-btn replay-btn-load",onClick:()=>q(),disabled:$,children:$?"Loading...":"Load"})]}),n.jsxs("div",{className:"replay-playback",children:[n.jsx("button",{className:"replay-btn replay-btn-play",onClick:de,disabled:c.length===0,children:_?"⏸":N>=c.length&&c.length>0?"⟳":"▶"}),n.jsx("div",{className:"replay-speed-btns",children:Te.map(t=>n.jsxs("button",{className:`replay-btn replay-btn-speed ${M===t?"active":""}`,onClick:()=>ce(t),children:[t,"x"]},t))})]}),n.jsxs("div",{className:"replay-clock",children:[n.jsx("span",{className:"replay-clock-date",children:F?je(F):""}),n.jsx("span",{className:"replay-clock-time",children:xe(F)})]}),n.jsxs("div",{className:"replay-stats",children:[n.jsxs("span",{children:[W.size," chatting"]}),n.jsxs("span",{children:[b.size," games"]}),n.jsxs("span",{children:[N,"/",c.length]})]})]}),c.length>0&&n.jsxs("div",{className:"replay-scrubber",children:[n.jsx("input",{type:"range",min:0,max:c.length,value:N,onChange:ie,className:"replay-range"}),n.jsx("div",{className:"replay-progress-bar",style:{width:`${fe}%`}})]}),K&&n.jsx("div",{className:"replay-error",children:K}),P&&!c.length&&!$&&n.jsx("div",{className:"replay-summary",children:P.totalEvents>0?`${P.totalEvents.toLocaleString()} events recorded · ${((se=P.days)==null?void 0:se.length)||0} days`:"No events recorded yet. Events will appear once the server starts recording."})]}),n.jsxs("div",{className:"replay-viz",children:[n.jsxs("div",{className:"replay-panel replay-world-map",children:[n.jsxs("div",{className:"replay-section-header",children:[n.jsx("span",{className:"replay-section-title",children:"World Map"}),n.jsxs("span",{className:"replay-section-count",children:[ne.size," countries"]})]}),n.jsx(be,{playerCountries:ne,players:he,instant:!0,animationScale:Z,time:F})]}),n.jsxs("div",{className:"replay-panel replay-mmr-chart",children:[n.jsxs("div",{className:"replay-section-header",children:[n.jsx("span",{className:"replay-section-title",children:"MMR Distribution"}),n.jsxs("span",{className:"replay-section-count",children:[Y.length," players"]})]}),Y.length>0?n.jsx(Me,{players:Y,matches:ge,onPlayerClick:pe,mmrRange:me,animationScale:Z}):n.jsx("div",{className:"replay-empty",children:"Waiting for match data..."})]}),n.jsx(ve,{events:oe,onEventClick:ue,className:"replay-panel replay-events"})]})]})};export{Ee as default};

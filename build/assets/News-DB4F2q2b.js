import{x as W,r as j,j as e,s as q,L as F,C as H}from"./index-gv0ar0p9.js";import{F as U}from"./index-yLDsqMf7.js";import"./iconBase-BSiZnbeB.js";const C="https://4v4gg-chat-relay.fly.dev",R=[{key:"TOPICS",label:"Topics",cls:"topics",tags:!0},{key:"DRAMA",label:"Drama",cls:"drama"},{key:"BANS",label:"Bans",cls:"bans"},{key:"HIGHLIGHTS",label:"Highlights",cls:"highlights"},{key:"WINNER",label:"Winner",cls:"winner",stat:!0},{key:"LOSER",label:"Loser",cls:"loser",stat:!0},{key:"GRINDER",label:"Grinder",cls:"grinder",stat:!0},{key:"HOTSTREAK",label:"Hot",cls:"hotstreak",stat:!0},{key:"COLDSTREAK",label:"Cold",cls:"coldstreak",stat:!0}],G=[...R.map(s=>s.key),"MENTIONS"],Y=new RegExp(`^(${G.join("|")})\\s*:\\s*`,"gm"),z=s=>{const t=[],n=[...s.matchAll(Y)];for(let i=0;i<n.length;i++){const c=n[i],u=c.index+c[0].length,f=i+1<n.length?n[i+1].index:s.length,m=s.slice(u,f).trim();m&&t.push({key:c[1],content:m})}return t},J=s=>{const t=s.find(i=>i.key==="MENTIONS");if(!t)return new Map;const n=new Map;for(const i of t.content.split(",")){const c=i.trim();if(!c)continue;const u=c.split("#")[0];u&&n.set(u,c)}return n},O=s=>{const t=s.match(/^(.+?#\d+)\s+(.+?)\s+\((\d+)W-(\d+)L\)\s*([WL]*)$/);return t?{battleTag:t[1],name:t[1].split("#")[0],headline:t[2],wins:parseInt(t[3]),losses:parseInt(t[4]),form:t[5]||""}:null},K=/\b([a-f0-9]{24})\b/g,Q=s=>{const t=[];let n=0;for(const i of s.matchAll(K))i.index>n&&t.push(s.slice(n,i.index)),t.push(e.jsxs(F,{to:`/match/${i[1]}`,className:"digest-match-link",children:["match ",e.jsx(U,{size:11})]},`m${i.index}`)),n=i.index+i[0].length;return n<s.length&&t.push(s.slice(n)),t.length>0?t:[s]},T=(s,t)=>{const n=Q(s);if(!t||t.size===0)return n;const c=[...t].sort((m,r)=>r.length-m.length).map(m=>m.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),u=new RegExp(`\\b(${c.join("|")})\\b`,"gi"),f=[];for(const m of n){if(typeof m!="string"){f.push(m);continue}let r=0;for(const p of m.matchAll(u))p.index>r&&f.push(m.slice(r,p.index)),f.push(e.jsx("span",{className:"digest-name",children:p[0]},p.index)),r=p.index+p[0].length;r<m.length&&f.push(m.slice(r))}return f},D=(s,t)=>{const n=new Set,i=s.toLowerCase();for(const[c,u]of t){if(c.length<2)continue;const f=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`\\b${f}\\b`,"i").test(s))n.add(u);else if(c.length>=7){const r=c.toLowerCase();for(const p of i.split(/\W+/))if(p.length>=6&&r.startsWith(p)){n.add(u);break}}}return[...n]},B=/"([^"]+)"/g,P=s=>{const t=[];let n=s;for(const i of s.matchAll(B))t.push(i[1]);return t.length>0&&(n=s.replace(B,"").replace(/\btold him to\s*and\b/gi,"").replace(/\bwhere \w+ told him\s*and\b/gi,"").replace(/\bcalling him\s*$/gi,"").replace(/\bcalling him\s+and\b/gi,"").replace(/'\s+of\b/g,"'s").replace(/\s*[â€”:,]\s*$/g,"").replace(/\s{2,}/g," ").trim()),{summary:n,quotes:t}},_=s=>{const t=new Date().toISOString().slice(0,10);if(s===t)return"Today so far";const n=new Date(Date.now()-864e5).toISOString().slice(0,10);if(s===n)return"Yesterday";const i=new Date(s+"T12:00:00"),c=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],u=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${c[i.getDay()]} ${u[i.getMonth()]} ${i.getDate()}`},I=({src:s,country:t})=>e.jsxs("span",{className:"digest-avatar-wrap",children:[e.jsx("img",{src:s,alt:"",className:"digest-avatar",onError:n=>{n.target.style.display="none"}}),t&&e.jsx(H,{name:t.toLowerCase(),className:"digest-avatar-flag"})]}),V=({form:s})=>s?e.jsx("span",{className:"digest-form-dots",children:s.split("").map((t,n)=>e.jsx("span",{className:`digest-form-dot ${t==="W"?"digest-form-dot--w":"digest-form-dot--l"}`},n))}):null,X=({stat:s,cls:t,label:n,profiles:i})=>{const c=i.get(s.battleTag);return e.jsxs("div",{className:`digest-section digest-section--${t}`,children:[e.jsx("span",{className:"digest-section-label",children:n}),e.jsxs("div",{className:"digest-stat",children:[(c==null?void 0:c.pic)&&e.jsx(I,{src:c.pic,country:c.country}),e.jsx(F,{to:`/player/${encodeURIComponent(s.battleTag)}`,className:"digest-stat-name",children:s.name}),e.jsx("span",{className:"digest-stat-headline",children:s.headline}),e.jsx(V,{form:s.form})]})]})},Z=({digest:s,nameSet:t,nameToTag:n,label:i="Yesterday in 4v4",dateTabs:c})=>{if(!s)return null;const u=s.digest||"",f=j.useMemo(()=>z(u),[u]),m=j.useMemo(()=>J(f),[f]),r=j.useMemo(()=>{const a=new Map(m);if(n)for(const[o,d]of n)a.has(o)||a.set(o,d);return a},[m,n]),p=j.useMemo(()=>{const a=f.filter(l=>l.key!=="MENTIONS"),o=a.find(l=>l.key==="BANS");if(!o)return a;const d=new Set;for(const[l]of r){if(l.length<3)continue;const h=l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");new RegExp(`\\b${h}\\b`,"i").test(o.content)&&d.add(l)}return d.size===0?a:a.map(l=>{if(l.key!=="DRAMA")return l;const h=l.content.split(/;\s*/).filter(E=>![...d].some(N=>{const v=N.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`\\b${v}\\b`,"i").test(E)}));return h.length===0?null:{...l,content:h.join("; ")}}).filter(Boolean)},[f,r]),g=j.useMemo(()=>{const a=new Set(t);for(const o of r.keys())a.add(o);return a},[t,r]),[b,w]=j.useState(new Map),x=j.useRef(new Set);return j.useEffect(()=>{const a=new Set;for(const{key:o,content:d}of p){const l=R.find(h=>h.key===o);if(l!=null&&l.stat){const h=O(d);h&&a.add(h.battleTag)}else if(!(l!=null&&l.tags))for(const h of D(d,r))a.add(h)}for(const o of a)x.current.has(o)||(x.current.add(o),q(o).then(d=>{(d!=null&&d.profilePicUrl||d!=null&&d.country)&&w(l=>{const h=new Map(l);return h.set(o,{pic:d.profilePicUrl,country:d.country}),h})}))},[p,r]),p.length===0?e.jsxs("div",{className:"news-digest",children:[e.jsx("div",{className:"news-digest-header",children:c&&c.length>1?e.jsx("div",{className:"digest-date-tabs",children:c.map((a,o)=>e.jsx("button",{className:`digest-date-tab${a.active?" digest-date-tab--active":""}`,onClick:a.onClick,children:a.label},o))}):e.jsx("div",{className:"news-digest-label",children:i})}),e.jsx("p",{className:"digest-section-text",children:T(u,g)})]}):e.jsxs("div",{className:"news-digest",children:[e.jsx("div",{className:"news-digest-header",children:c&&c.length>1?e.jsx("div",{className:"digest-date-tabs",children:c.map((a,o)=>e.jsx("button",{className:`digest-date-tab${a.active?" digest-date-tab--active":""}`,onClick:a.onClick,children:a.label},o))}):e.jsx("div",{className:"news-digest-label",children:i})}),e.jsx("div",{className:"digest-sections",children:p.map(({key:a,content:o})=>{const d=R.find(N=>N.key===a);if(!d)return null;const{cls:l,label:h}=d;if(d.stat){const N=O(o);if(N)return e.jsx(X,{stat:N,cls:l,label:h,profiles:b},a)}if(d.tags)return e.jsxs("div",{className:`digest-section digest-section--${l}`,children:[e.jsx("span",{className:"digest-section-label",children:h}),e.jsx("span",{className:"digest-tags",children:o.split(/,\s*/).filter(Boolean).map((N,v)=>e.jsx("span",{className:"digest-tag",children:N.trim()},v))})]},a);const E=o.split(/;\s*/).map(N=>N.trim()).filter(Boolean);return e.jsxs("div",{className:`digest-section digest-section--${l}`,children:[e.jsx("span",{className:"digest-section-label",children:h}),E.length>1?e.jsx("ul",{className:"digest-bullets",children:E.map((N,v)=>{const y=D(N,r).map(S=>b.get(S)).filter(Boolean).filter(S=>S.pic).map((S,M)=>e.jsx(I,{src:S.pic,country:S.country},M)),{summary:k,quotes:A}=P(N);return e.jsxs("li",{className:"digest-bullet-row",children:[e.jsx("div",{className:"digest-avatars",children:y}),e.jsxs("div",{className:"digest-bullet-content",children:[e.jsx("span",{className:"digest-section-text",children:T(k,g)}),A.length>0&&e.jsx("div",{className:"digest-quotes",children:A.map((S,M)=>e.jsx("div",{className:"digest-quote",children:S},M))})]})]},v)})}):e.jsx("div",{className:"digest-section-body",children:(()=>{const v=D(o,r).map(y=>b.get(y)).filter(Boolean),{summary:L,quotes:$}=P(o);return e.jsxs(e.Fragment,{children:[v.length>0&&e.jsx("div",{className:"digest-avatars",children:v.map((y,k)=>y.pic&&e.jsx(I,{src:y.pic,country:y.country},k))}),e.jsxs("div",{className:"digest-bullet-content",children:[e.jsx("span",{className:"digest-section-text",children:T(L,g)}),$.length>0&&e.jsx("div",{className:"digest-quotes",children:$.map((y,k)=>e.jsx("div",{className:"digest-quote",children:y},k))})]})]})})()})]},a)})})]})},ne=()=>{const{onlineUsers:s,messages:t}=W(),[n,i]=j.useState([]),[c,u]=j.useState(0);j.useEffect(()=>{Promise.all([fetch(`${C}/api/admin/stats/today`).then(g=>g.ok?g.json():null).catch(()=>null),fetch(`${C}/api/admin/digests`).then(g=>g.ok?g.json():[]).catch(()=>[])]).then(([g,b])=>{const w=[];g!=null&&g.digest&&w.push(g);for(const x of b)w.some(a=>a.date===x.date)||w.push(x);i(w)})},[]);const{nameSet:f,nameToTag:m}=j.useMemo(()=>{const g=new Set,b=new Map;for(const w of s){const x=w.battleTag,a=x==null?void 0:x.split("#")[0];a&&(g.add(a),b.set(a,x))}for(const w of t){const x=w.battle_tag||w.battleTag,a=x==null?void 0:x.split("#")[0];a&&(g.add(a),b.has(a)||b.set(a,x))}return{nameSet:g,nameToTag:b}},[s,t]),r=n[c]||null,p=r?_(r.date):null;return e.jsx("div",{className:"news",children:e.jsx("div",{className:"news-container",children:n.length>0?e.jsx(Z,{digest:r,nameSet:f,nameToTag:m,label:p,dateTabs:n.map((g,b)=>({label:_(g.date),active:b===c,onClick:()=>u(b)}))}):e.jsx("div",{className:"news-empty",children:"No digests available yet."})})})};export{ne as default};

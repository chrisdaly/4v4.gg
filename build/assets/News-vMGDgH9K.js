import{x as O,r as j,j as e,s as P,L as W,C as B}from"./index-CZG87t5B.js";const I="https://4v4gg-chat-relay.fly.dev",E=[{key:"TOPICS",label:"Topics",cls:"topics",tags:!0},{key:"DRAMA",label:"Drama",cls:"drama"},{key:"BANS",label:"Bans",cls:"bans"},{key:"HIGHLIGHTS",label:"Highlights",cls:"highlights"},{key:"WINNER",label:"Winner",cls:"winner",stat:!0},{key:"LOSER",label:"Loser",cls:"loser",stat:!0},{key:"GRINDER",label:"Grinder",cls:"grinder",stat:!0},{key:"HOTSTREAK",label:"Hot",cls:"hotstreak",stat:!0},{key:"COLDSTREAK",label:"Cold",cls:"coldstreak",stat:!0}],H=[...E.map(s=>s.key),"MENTIONS"],_=new RegExp(`^(${H.join("|")})\\s*:\\s*`,"gm"),F=s=>{const n=[],i=[...s.matchAll(_)];for(let c=0;c<i.length;c++){const a=i[c],o=a.index+a[0].length,m=c+1<i.length?i[c+1].index:s.length,d=s.slice(o,m).trim();d&&n.push({key:a[1],content:d})}return n},G=s=>{const n=s.find(c=>c.key==="MENTIONS");if(!n)return new Map;const i=new Map;for(const c of n.content.split(",")){const a=c.trim();if(!a)continue;const o=a.split("#")[0];o&&i.set(o,a)}return i},L=s=>{const n=s.match(/^(.+?#\d+)\s+(.+?)\s+\((\d+)W-(\d+)L\)\s*([WL]*)$/);return n?{battleTag:n[1],name:n[1].split("#")[0],headline:n[2],wins:parseInt(n[3]),losses:parseInt(n[4]),form:n[5]||""}:null},k=(s,n)=>{if(!n||n.size===0)return[s];const c=[...n].sort((d,u)=>u.length-d.length).map(d=>d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),a=new RegExp(`\\b(${c.join("|")})\\b`,"gi"),o=[];let m=0;for(const d of s.matchAll(a))d.index>m&&o.push(s.slice(m,d.index)),o.push(e.jsx("span",{className:"digest-name",children:d[0]},d.index)),m=d.index+d[0].length;return m<s.length&&o.push(s.slice(m)),o},T=(s,n)=>{const i=new Set,c=s.toLowerCase();for(const[a,o]of n){if(a.length<2)continue;const m=a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`\\b${m}\\b`,"i").test(s))i.add(o);else if(a.length>=4){const u=a.toLowerCase();for(const w of c.split(/\W+/))if(w.length>=4&&u.startsWith(w)){i.add(o);break}}}return[...i]},C=s=>{const n=new Date().toISOString().slice(0,10);if(s===n)return"Today so far";const i=new Date(Date.now()-864e5).toISOString().slice(0,10);if(s===i)return"Yesterday";const c=new Date(s+"T12:00:00"),a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${a[c.getDay()]} ${o[c.getMonth()]} ${c.getDate()}`},M=({src:s,country:n})=>e.jsxs("span",{className:"digest-avatar-wrap",children:[e.jsx("img",{src:s,alt:"",className:"digest-avatar",onError:i=>{i.target.style.display="none"}}),n&&e.jsx(B,{name:n.toLowerCase(),className:"digest-avatar-flag"})]}),U=({form:s})=>s?e.jsx("span",{className:"digest-form-dots",children:s.split("").map((n,i)=>e.jsx("span",{className:`digest-form-dot ${n==="W"?"digest-form-dot--w":"digest-form-dot--l"}`},i))}):null,Y=({stat:s,cls:n,label:i,profiles:c})=>{const a=c.get(s.battleTag);return e.jsxs("div",{className:`digest-section digest-section--${n}`,children:[e.jsx("span",{className:"digest-section-label",children:i}),e.jsxs("div",{className:"digest-stat",children:[(a==null?void 0:a.pic)&&e.jsx(M,{src:a.pic,country:a.country}),e.jsx(W,{to:`/player/${encodeURIComponent(s.battleTag)}`,className:"digest-stat-name",children:s.name}),e.jsx("span",{className:"digest-stat-headline",children:s.headline}),e.jsx(U,{form:s.form})]})]})},J=({digest:s,nameSet:n,nameToTag:i,label:c="Yesterday in 4v4",dateTabs:a})=>{if(!s)return null;const o=s.digest||"",m=j.useMemo(()=>F(o),[o]),d=j.useMemo(()=>G(m),[m]),u=j.useMemo(()=>{const t=new Map(d);if(i)for(const[l,g]of i)t.has(l)||t.set(l,g);return t},[d,i]),w=j.useMemo(()=>m.filter(t=>t.key!=="MENTIONS"),[m]),r=j.useMemo(()=>{const t=new Set(n);for(const l of u.keys())t.add(l);return t},[n,u]),[f,b]=j.useState(new Map),h=j.useRef(new Set);return j.useEffect(()=>{const t=new Set;for(const{key:l,content:g}of w){const x=E.find(p=>p.key===l);if(x!=null&&x.stat){const p=L(g);p&&t.add(p.battleTag)}else if(!(x!=null&&x.tags))for(const p of T(g,u))t.add(p)}for(const l of t)h.current.has(l)||(h.current.add(l),P(l).then(g=>{(g!=null&&g.profilePicUrl||g!=null&&g.country)&&b(x=>{const p=new Map(x);return p.set(l,{pic:g.profilePicUrl,country:g.country}),p})}))},[w,u]),w.length===0?e.jsxs("div",{className:"news-digest",children:[e.jsx("div",{className:"news-digest-header",children:a&&a.length>1?e.jsx("div",{className:"digest-date-tabs",children:a.map((t,l)=>e.jsx("button",{className:`digest-date-tab${t.active?" digest-date-tab--active":""}`,onClick:t.onClick,children:t.label},l))}):e.jsx("div",{className:"news-digest-label",children:c})}),e.jsx("p",{className:"digest-section-text",children:k(o,r)})]}):e.jsxs("div",{className:"news-digest",children:[e.jsx("div",{className:"news-digest-header",children:a&&a.length>1?e.jsx("div",{className:"digest-date-tabs",children:a.map((t,l)=>e.jsx("button",{className:`digest-date-tab${t.active?" digest-date-tab--active":""}`,onClick:t.onClick,children:t.label},l))}):e.jsx("div",{className:"news-digest-label",children:c})}),e.jsx("div",{className:"digest-sections",children:w.map(({key:t,content:l})=>{const g=E.find(N=>N.key===t);if(!g)return null;const{cls:x,label:p}=g;if(g.stat){const N=L(l);if(N)return e.jsx(Y,{stat:N,cls:x,label:p,profiles:f},t)}if(g.tags)return e.jsxs("div",{className:`digest-section digest-section--${x}`,children:[e.jsx("span",{className:"digest-section-label",children:p}),e.jsx("span",{className:"digest-tags",children:l.split(/,\s*/).filter(Boolean).map((N,y)=>e.jsx("span",{className:"digest-tag",children:N.trim()},y))})]},t);const D=l.split(/;\s*/).map(N=>N.trim()).filter(Boolean);return e.jsxs("div",{className:`digest-section digest-section--${x}`,children:[e.jsx("span",{className:"digest-section-label",children:p}),D.length>1?e.jsx("ul",{className:"digest-bullets",children:D.map((N,y)=>{const R=T(N,u).map(S=>f.get(S)).filter(Boolean).filter(S=>S.pic).map((S,A)=>e.jsx(M,{src:S.pic,country:S.country},A));return e.jsxs("li",{className:"digest-bullet-row",children:[e.jsx("div",{className:"digest-avatars",children:R}),e.jsx("span",{className:"digest-section-text",children:k(N,r)})]},y)})}):e.jsxs("div",{className:"digest-section-body",children:[(()=>{const y=T(l,u).map(v=>f.get(v)).filter(Boolean);return y.length>0?e.jsx("div",{className:"digest-avatars",children:y.map((v,$)=>v.pic&&e.jsx(M,{src:v.pic,country:v.country},$))}):null})(),e.jsx("span",{className:"digest-section-text",children:k(l,r)})]})]},t)})})]})},z=()=>{const{onlineUsers:s,messages:n}=O(),[i,c]=j.useState([]),[a,o]=j.useState(0);j.useEffect(()=>{Promise.all([fetch(`${I}/api/admin/stats/today`).then(r=>r.ok?r.json():null).catch(()=>null),fetch(`${I}/api/admin/digests`).then(r=>r.ok?r.json():[]).catch(()=>[])]).then(([r,f])=>{const b=[];r!=null&&r.digest&&b.push(r);for(const h of f)b.some(t=>t.date===h.date)||b.push(h);c(b)})},[]);const{nameSet:m,nameToTag:d}=j.useMemo(()=>{const r=new Set,f=new Map;for(const b of s){const h=b.battleTag,t=h==null?void 0:h.split("#")[0];t&&(r.add(t),f.set(t,h))}for(const b of n){const h=b.battle_tag||b.battleTag,t=h==null?void 0:h.split("#")[0];t&&(r.add(t),f.has(t)||f.set(t,h))}return{nameSet:r,nameToTag:f}},[s,n]),u=i[a]||null,w=u?C(u.date):null;return e.jsx("div",{className:"news",children:e.jsx("div",{className:"news-container",children:i.length>0?e.jsx(J,{digest:u,nameSet:m,nameToTag:d,label:w,dateTabs:i.map((r,f)=>({label:C(r.date),active:f===a,onClick:()=>o(f)}))}):e.jsx("div",{className:"news-empty",children:"No digests available yet."})})})};export{z as default};
